unit FrmFacturaClientes01;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils,
  System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, RzPanel, Vcl.StdCtrls,
  Vcl.Buttons, Vcl.ComCtrls, RzListVw, RzStatus, Vcl.Mask, RxToolEdit,
  RxCurrEdit, Vcl.ImgList,
  System.RegularExpressions, uDL_Skeleton, Vcl.Menus, RzButton,
  System.DateUtils,
  FireDAC.Comp.Client, Data.DB, uDL_TB_FACTURASCLIENTESDETALLE,
  uDL_TB_AsientosEncabezado, uDL_TB_AsientosDetalle, Vcl.Imaging.jpeg,
  Winapi.ShellAPI, RzEdit;

type
  TFormFacturaClientes01 = class(TForm)
    pnlEncabezado: TRzPanel;
    pnlTitulo: TRzPanel;
    pnlTitulo1: TRzPanel;
    pnlTitulo2: TRzPanel;
    pnlEstado: TRzPanel;
    pnlEstado1: TRzPanel;
    pnlEstado2: TRzPanel;
    pnlOpciones: TRzPanel;
    pnlOpciones1: TRzPanel;
    pnlTotal: TRzPanel;
    btnPagar: TBitBtn;
    btnNuevo: TBitBtn;
    btnAnular: TBitBtn;
    btnCerrar: TBitBtn;
    pnlCampos: TRzPanel;
    pnlPie: TRzPanel;
    pnlDetalle: TRzPanel;
    pnlListaTitulo: TRzPanel;
    chkTodoLista1: TCheckBox;
    stbEstado1: TRzStatusBar;
    RzStatusPane1: TRzStatusPane;
    lvLista1: TRzListView;
    pnlSubTotal: TRzPanel;
    Label1: TLabel;
    pnlDescuento: TRzPanel;
    Label2: TLabel;
    pnlServicio: TRzPanel;
    Label3: TLabel;
    pnlImpuesto: TRzPanel;
    Label4: TLabel;
    pnlDetalle2: TRzPanel;
    pnlDetalle1: TRzPanel;
    pnlDetalle11: TRzPanel;
    pnlDetalle12: TRzPanel;
    pnlCodigoProducto: TRzPanel;
    Label5: TLabel;
    pnlCodigoBarras: TRzPanel;
    Label6: TLabel;
    pnlCantidad: TRzPanel;
    Label7: TLabel;
    pnlDescuentoDetalle: TRzPanel;
    Label8: TLabel;
    pnlProducto: TRzPanel;
    Label9: TLabel;
    pnlPrecio: TRzPanel;
    Label10: TLabel;
    pnlExistencia: TRzPanel;
    Label11: TLabel;
    pnlDescripcion1: TRzPanel;
    Label12: TLabel;
    pnlDescripcion2: TRzPanel;
    Label13: TLabel;
    edtCodigoProducto: TButtonedEdit;
    edtCodigoBarras: TButtonedEdit;
    edtProductoNombre: TButtonedEdit;
    edtDescripcion1: TButtonedEdit;
    edtDescripcion2: TButtonedEdit;
    edtDescuento: TCurrencyEdit;
    edtPrecio: TCurrencyEdit;
    edtExistencia: TCurrencyEdit;
    ImageList1: TImageList;
    btnEliminarLinea: TBitBtn;
    btnInsertarLinea: TBitBtn;
    pnlEstado4: TRzPanel;
    pnlEstado3: TRzPanel;
    Label14: TLabel;
    Label15: TLabel;
    cbCliente: TComboBoxEx;
    cbVendedor: TComboBoxEx;
    Label16: TLabel;
    edtLimiteCredito: TCurrencyEdit;
    edtCantidad: TCurrencyEdit;
    btnBuscar_Clientes: TBitBtn;
    btnBuscar_Vendedores: TBitBtn;
    popImprimir: TPopupMenu;
    Imprimir1: TMenuItem;
    VistaPrevia1: TMenuItem;
    btnImprimir: TRzToolButton;
    lblFechaVencimiento: TLabel;
    popDetalle: TPopupMenu;
    Incluirproductofueradeinventario1: TMenuItem;
    Usarpreciomayorista1: TMenuItem;
    CambiarCantidad1: TMenuItem;
    btnDescuentoMonto: TBitBtn;
    imgAnulado: TImage;
    dtpFecha: TRzDateTimeEdit;
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnNuevoClick(Sender: TObject);
    procedure btnPagarClick(Sender: TObject);
    procedure btnAnularClick(Sender: TObject);
    procedure btnCerrarClick(Sender: TObject);
    procedure btnBuscar_ClientesClick(Sender: TObject);
    procedure btnBuscar_VendedoresClick(Sender: TObject);
    procedure btnInsertarLineaClick(Sender: TObject);
    procedure btnEliminarLineaClick(Sender: TObject);
    procedure Imprimir1Click(Sender: TObject);
    procedure VistaPrevia1Click(Sender: TObject);
    procedure edtCodigoProductoExit(Sender: TObject);
    procedure edtCodigoBarrasExit(Sender: TObject);
    procedure edtProductoNombreRightButtonClick(Sender: TObject);
    procedure cbClienteChange(Sender: TObject);
    procedure chkTodoLista1Click(Sender: TObject);
    procedure edtCodigoProductoRightButtonClick(Sender: TObject);
    procedure Incluirproductofueradeinventario1Click(Sender: TObject);
    procedure Usarpreciomayorista1Click(Sender: TObject);
    procedure edtCodigoProductoKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edtCodigoBarrasKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edtCantidadKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure CambiarCantidad1Click(Sender: TObject);
    procedure btnDescuentoMontoClick(Sender: TObject);
    procedure cbClienteKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure lvLista1KeyPress(Sender: TObject; var Key: Char);
    procedure edtCodigoBarrasKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edtCodigoBarrasKeyPress(Sender: TObject; var Key: Char);
  private
    FIdDocumento: Integer;
    FIdEstado: Integer;
    FIdFormaPago: Integer;
    FNumero: Integer;
    FOrigen: Integer;
    FOrden: Integer;
    FIdCliente: Integer;
  public
    _DL_TB_FACTURASDETALLEActual: TDL_TB_FACTURASCLIENTESDETALLE;
    property _IdDocumento: Integer read FIdDocumento write FIdDocumento;
    property _IdEstado: Integer read FIdEstado write FIdEstado;
    property _IdFormaPago: Integer read FIdFormaPago write FIdFormaPago;
    property _Numero: Integer read FNumero write FNumero;
    property _Origen: Integer read FOrigen write FOrigen;
    property _Orden: Integer read FOrden write FOrden;
    property _IdCliente: Integer read FIdCliente write FIdCliente;
  end;

  Clase_Tipo2 = TDL_TB_FACTURASCLIENTESDETALLE;

var
  FormFacturaClientes01: TFormFacturaClientes01;
  _DL_TB_FACTURASDETALLEAux: TDL_TB_FACTURASCLIENTESDETALLE;

  procedure InicializarForma;
  procedure FinalizarForma;
  procedure KeyDownForma(var Key: Word; Shift: TShiftState);
  procedure LimpiarCampos;
  procedure LimpiarCampos_Titulo;
  procedure LimpiarCampos_Encabezado;
  procedure LimpiarCampos_DetalleCampos;
  procedure LimpiarCampos_DetalleLista;
  procedure LimpiarCampos_Pie;
  procedure Insertar_Detalle;
  procedure Eliminar_Detalle;
  procedure LlenarlvLista1(lv: TRzListView; ds1: TDatasetMem);
  procedure Buscar_ProductoCodigo(pTexto: string);
  procedure Buscar_ProductoCodigoBarras(pTexto: string);
  procedure DBToFormaDetalle(ds1: TDatasetMem);
  procedure ActualizarTotales(ds1: TDatasetMem);
  procedure LlenarcbClientes(cb: TComboBoxEx);
  procedure LlenarcbVendedores(cb: TComboBoxEx);
  procedure Consultar_Cliente(pId: Integer);
  procedure MDLista_Todos(lv: TRzListView; chk: TCheckBox);
  procedure Nuevo;
  procedure Pagar_Data;
  procedure Pagar_DataDefault;
  procedure Anular_Data;
  procedure Imprimir_Data;
  procedure VistaPrevia;
  procedure Cerrar;
  procedure Consultar_Encabezado(pId: Integer);
  procedure DBToFormaEncabezado(ds1: TDatasetMem);
  procedure Consultar_Detalle(pId: Integer);
  procedure CamposValidos_Pagar1;
  procedure CamposValidos_Pagar2;
  procedure CamposValidos_Detalle;
  procedure ProductoFueraInventario;
  procedure UsarPrecioMayorista;
  procedure CambiarDetalle;
  procedure CambiarDetalleCantidad(pOperacion: Integer);
  procedure DescuentoMonto;
  procedure Insertar_AsientoDetalle(pAsientoDetalle: TDL_TB_AsientosDetalle;
    pIdAsiento: Integer; pTipoPago: Integer);
  procedure Insertar_AsientoDetalle_Anulado(pAsientoDetalle: TDL_TB_AsientosDetalle;
    pIdAsiento: Integer; pTipoPago: Integer);
  procedure Actualizar_Detalles(ds1: TDatasetMem);
  procedure Sumar;
  procedure Restar;
  procedure CargarIdioma;

implementation

uses
  uSistema, ufunciones, udmObjects, uDL_TB_FACTURASCLIENTESENCABEZADO, BS_DBConexion,
  FrmMensaje_Espera01, uDL_TB_PRODUCTOS,
  uDL_TB_CLIENTES, uDL_TB_VENDEDORES, FrmMantenimientoClientes01,
  FrmMantenimientoVendedores01, FrmMantenimientoProductos01,
  uDL_TB_CONSECUTIVOS, FrmBuscar_Productos01, uDL_TB_PLANTILLAS,
  FrmPagar01, udmReports, uDL_TB_EMPRESAS, uDL_TB_NOTASCREDITOENCABEZADO,
  FrmProductoFueraInventario01, uDL_TB_OrdenesEncabezado,
  uDL_TB_OrdenesDetalle, FrmCambiarDetalle01, FrmDesuentoMonto01,
  DL_DBGeneral, uDL_TB_NOTASCREDITODETALLE, FrmNotasCredito01, udmLenguajes,
  uDL_TB_DOCUMENTOSHACIENDA, uHacienda, uAuxiliares,
  uDL_tb_docunentosencabezado, uDL_tb_docunentosdetalle,
  uDL_tb_documentosdescuentos, uDL_tb_docunentosimpuestos,
  uDL_tb_documentosotroscargos, uDL_tb_empresas2, udmConnection;

{$R *.dfm}

type
  Clase_Tipo1 = TDL_TB_FACTURASCLIENTESENCABEZADO;

const
  lv_Nombre = 0;
  lv_id = 1;

var
  Forma01: TFormFacturaClientes01;
  _IdProducto: Integer;
  _SubTotal: Double;
  _DescuentoM: Double;
  _IVAM: Double;
  _ISM: Double;
  _Total: Double;

{$REGION 'Funciones Forma'}
procedure TFormFacturaClientes01.FormShow(Sender: TObject);
begin
  Forma01 := FormFacturaClientes01;

  InicializarForma;
end;

procedure TFormFacturaClientes01.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  FinalizarForma;
end;

procedure TFormFacturaClientes01.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  KeyDownForma(Key, Shift);
end;

procedure TFormFacturaClientes01.btnNuevoClick(Sender: TObject);
begin
  Nuevo;
end;

procedure TFormFacturaClientes01.btnPagarClick(Sender: TObject);
begin
  Pagar_Data;
end;

procedure TFormFacturaClientes01.CambiarCantidad1Click(Sender: TObject);
begin
  CambiarDetalle;
end;

procedure TFormFacturaClientes01.btnAnularClick(Sender: TObject);
begin
  Anular_Data;
end;

procedure TFormFacturaClientes01.Imprimir1Click(Sender: TObject);
begin
  Imprimir_Data;
end;

procedure TFormFacturaClientes01.VistaPrevia1Click(Sender: TObject);
begin
  VistaPrevia;
end;

procedure TFormFacturaClientes01.btnCerrarClick(Sender: TObject);
begin
  Cerrar;
end;

procedure TFormFacturaClientes01.btnDescuentoMontoClick(Sender: TObject);
begin
  DescuentoMonto;
end;

procedure TFormFacturaClientes01.btnBuscar_ClientesClick(Sender: TObject);
begin
  FormMantenimientoClientes01.ShowModal;
  LlenarcbClientes(cbCliente);
end;

procedure TFormFacturaClientes01.btnBuscar_VendedoresClick(Sender: TObject);
begin
  FormMantenimientoVendedores01.ShowModal;
  LlenarcbVendedores(cbVendedor);
end;

procedure TFormFacturaClientes01.btnInsertarLineaClick(Sender: TObject);
begin
  Insertar_Detalle;
  if Global.CodigoBarrasDirecto = 0 then
    edtCodigoProducto.SetFocus;
  if Global.CodigoBarrasDirecto = 1 then
    edtCodigoBarras.SetFocus;
end;

procedure TFormFacturaClientes01.btnEliminarLineaClick(Sender: TObject);
begin
  Eliminar_Detalle;
  if Global.CodigoBarrasDirecto = 0 then
    edtCodigoProducto.SetFocus;
  if Global.CodigoBarrasDirecto = 1 then
    edtCodigoBarras.SetFocus;
end;

procedure TFormFacturaClientes01.edtCodigoProductoExit(Sender: TObject);
begin
  Buscar_ProductoCodigo(edtCodigoProducto.Text);
end;

procedure TFormFacturaClientes01.edtCodigoBarrasExit(Sender: TObject);
begin
  Buscar_ProductoCodigoBarras(edtCodigoBarras.Text);
end;

procedure TFormFacturaClientes01.edtCodigoProductoRightButtonClick(
  Sender: TObject);
begin
  FormBuscar_Productos01.ShowModal;
  if FormBuscar_Productos01.Tag = 1 then
  begin
    edtCodigoProducto.Text := FormBuscar_Productos01._Codigo;
    Buscar_ProductoCodigo(edtCodigoProducto.Text);
  end;
  if Global.CodigoBarrasDirecto = 0 then
    edtCodigoProducto.SetFocus;
  if Global.CodigoBarrasDirecto = 1 then
    edtCodigoBarras.SetFocus;
end;

procedure TFormFacturaClientes01.edtProductoNombreRightButtonClick(
  Sender: TObject);
begin
  FormMantenimientoProductos01.ShowModal;
  if Global.CodigoBarrasDirecto = 0 then
    edtCodigoProducto.SetFocus;
  if Global.CodigoBarrasDirecto = 1 then
    edtCodigoBarras.SetFocus;
end;

procedure TFormFacturaClientes01.cbClienteChange(Sender: TObject);
begin
  if pnlEncabezado.Enabled = True then
  begin
    Consultar_Cliente(GetCombo(cbCliente));
    if Global.CodigoBarrasDirecto = 0 then
      edtCodigoProducto.SetFocus;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;
    if _DL_TB_FACTURASDETALLEActual <> nil then
    begin
      Actualizar_Detalles(_DL_TB_FACTURASDETALLEActual.Dataset);
      LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
      ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
    end;
  end;
end;

procedure TFormFacturaClientes01.cbClienteKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
  begin
    Key := 0;
    edtCodigoProducto.SetFocus;
  end;
end;

procedure TFormFacturaClientes01.chkTodoLista1Click(Sender: TObject);
begin
  MDLista_Todos(lvLista1, chkTodoLista1);
  if Global.CodigoBarrasDirecto = 0 then
    edtCodigoProducto.SetFocus;
  if Global.CodigoBarrasDirecto = 1 then
    edtCodigoBarras.SetFocus;
end;

procedure TFormFacturaClientes01.Incluirproductofueradeinventario1Click(
  Sender: TObject);
begin
  ProductoFueraInventario;
end;

procedure TFormFacturaClientes01.Usarpreciomayorista1Click(Sender: TObject);
begin
  UsarPrecioMayorista;
end;

procedure TFormFacturaClientes01.edtCodigoProductoKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
  begin
    Key := 0;
    edtCodigoBarras.SetFocus;
  end;
end;

procedure TFormFacturaClientes01.edtCodigoBarrasKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Global.CodigoBarrasDirecto = 0 then
  begin
    if Key = VK_RETURN then
    begin
      Key := 0;
      edtCantidad.SetFocus;
    end;
  end;
end;

procedure TFormFacturaClientes01.edtCodigoBarrasKeyPress(Sender: TObject;
  var Key: Char);
begin
  if Key = '+'	then
    Key := #0;
  if Key = '-'	then
    Key := #0;
 // if Key = Char(ord(#13))	then
 //   Key := '';
end;

procedure TFormFacturaClientes01.edtCodigoBarrasKeyUp(Sender: TObject;
  var Key: Word; Shift: TShiftState);
var
  mEncontrado: Boolean;
  mDL_TB_PRODUCTOS: TDL_TB_PRODUCTOS;
  mWhere: TStringList;
  mCodigo: string;
  mFila: Integer;
  mPasa1: Boolean;
begin
  if Global.CodigoBarrasDirecto = 1 then
  begin
    mPasa1 := False;
    if Key = VK_ReTurn then
    begin
      mPasa1 := True;
      Key := 0;
    end;
    if mPasa1 = True then
    begin
    mCodigo := Trim(edtCodigoBarras.Text);
      if Trim(mCodigo) <> '' then
      begin
        mWhere := TStringList.Create;
        mWhere.Add('CODIGOBARRAS=' + QuotedStr(Trim(mCodigo)));
        mDL_TB_PRODUCTOS := TDL_TB_PRODUCTOS.Create;
        mEncontrado :=
          mDL_TB_PRODUCTOS.Existe_Campo(mWhere.Text, 'CODIGOBARRAS',
          _Resultado, _ErrorM);
        mWhere.Free;
        mDL_TB_PRODUCTOS.Destroy;
        if mEncontrado = True then
        begin
          Buscar_ProductoCodigoBarras(mCodigo);
          mDL_TB_PRODUCTOS := TDL_TB_PRODUCTOS.Create;
          _IdProducto :=
            mDL_TB_PRODUCTOS.Obtener_Id('CODIGOBARRAS=' + QuotedStr(mCodigo), _Resultado, _ErrorM);
          mDL_TB_PRODUCTOS.Destroy;
          Insertar_Detalle;
          for mFila := 0 to lvLista1.Items.Count - 1 do
          begin
            if lvLista1.Items[mFila].SubItems[9] = mCodigo then
            begin
              lvLista1.ItemIndex := mFila;
              Break;
            end;
          end;
          edtCodigoBarras.SetFocus;
        end;
      end;
    end;
  end;
end;

procedure TFormFacturaClientes01.edtCantidadKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
  begin
    Key := 0;
    btnInsertarLinea.Click;
  end;
end;

procedure TFormFacturaClientes01.lvLista1KeyPress(Sender: TObject;
  var Key: Char);
begin
  if Key in ['+'] then
    Sumar;
  if Key in ['-'] then
    Restar;
end;
{$ENDREGION}

{$REGION 'Funciones Generales'}
procedure InicializarForma;
begin
  with Forma01 do
  begin

    try
      Tag := 0;

      //if _Origen = 1 then
      _DL_TB_FACTURASDETALLEActual := Clase_Tipo2.Create;
      if _Origen = 2 then
      begin
        _DL_TB_FACTURASDETALLEActual.Dataset.Close;
        _DL_TB_FACTURASDETALLEActual.Dataset.Data :=
          _AFACTURASCLIENTESDETALLEAux.Dataset.Data;
        _DL_TB_FACTURASDETALLEActual.Dataset.Open;
        _AFACTURASCLIENTESDETALLEAux.Dataset.Close;
        _AFACTURASCLIENTESDETALLEAux.Destroy;
      end;

      LlenarcbClientes(cbCliente);
      if _Resultado = -1 then
        raise Exception.Create('');

      LlenarcbVendedores(cbVendedor);
      if _Resultado = -1 then
        raise Exception.Create('');

      LimpiarCampos;
      CargarIdioma;

      if _IdEstado = 1 then
      begin
        btnPagar.Enabled := True;
        btnAnular.Enabled := False;
        btnImprimir.Enabled := False;
        pnlEstado.Enabled := True;
        pnlEncabezado.Enabled := True;
        pnlDetalle.Enabled := True;
        pnlListaTitulo.Enabled := True;
        lblFechaVencimiento.Visible := False;
        pnlTitulo2.Caption := 'Abierta';
        pnlEstado3.Caption := '';
        pnlEstado1.Caption := '';
        if Global.CodigoBarrasDirecto = 0 then
          edtCodigoProducto.SetFocus;
        if Global.CodigoBarrasDirecto = 1 then
          edtCodigoBarras.SetFocus;
        if _Origen = 2 then
        begin
          cbCliente.ItemIndex := SetCombo(cbCliente, _IdCliente);
          LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
          ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
        end;
      end;
      if _IdEstado = 2 then
      begin
        btnPagar.Enabled := False;
        btnAnular.Enabled := True;
        btnImprimir.Enabled := True;
        Consultar_Encabezado(_IdDocumento);
        Consultar_Detalle(_Numero);
        pnlEstado.Enabled := False;
        pnlEncabezado.Enabled := False;
        pnlDetalle.Enabled := False;
        pnlListaTitulo.Enabled := True;
        if _IdFormaPago = 1 then
          lblFechaVencimiento.Visible := False;
        if _IdFormaPago = 5 then
          lblFechaVencimiento.Visible := True;
        pnlTitulo2.Caption := 'Pagada';
        if _IdFormaPago = 1 then
          pnlEstado3.Caption := 'Contado';
        if _IdFormaPago = 5 then
          pnlEstado3.Caption := 'Crédito';
        pnlEstado1.Caption := 'Número: ' + IntToStr(_Numero);
      end;
      if _IdEstado = 3 then
      begin
        btnPagar.Enabled := False;
        btnAnular.Enabled := False;
        btnImprimir.Enabled := True;
        Consultar_Encabezado(_IdDocumento);
        Consultar_Detalle(_Numero);
        pnlEstado.Enabled := False;
        pnlEncabezado.Enabled := False;
        pnlDetalle.Enabled := False;
        pnlListaTitulo.Enabled := True;
        if _IdFormaPago = 1 then
          lblFechaVencimiento.Visible := False;
        if _IdFormaPago = 5 then
          lblFechaVencimiento.Visible := True;
        pnlTitulo2.Caption := 'Anulada';
        if _IdFormaPago = 1 then
          pnlEstado3.Caption := 'Contado';
        if _IdFormaPago = 5 then
          pnlEstado3.Caption := 'Crédito';
        pnlEstado1.Caption := 'Número: ' + IntToStr(_Numero);
        imgAnulado.Visible := True;
      end;
      if _IdEstado = 4 then
      begin
        btnPagar.Enabled := False;
        btnAnular.Enabled := True;
        btnImprimir.Enabled := True;
        Consultar_Encabezado(_IdDocumento);
        Consultar_Detalle(_Numero);
        pnlEstado.Enabled := False;
        pnlEncabezado.Enabled := False;
        pnlDetalle.Enabled := False;
        pnlListaTitulo.Enabled := True;
        if _IdFormaPago = 1 then
          lblFechaVencimiento.Visible := False;
        if _IdFormaPago = 5 then
          lblFechaVencimiento.Visible := True;
        pnlTitulo2.Caption := 'Pendiente';
        if _IdFormaPago = 1 then
          pnlEstado3.Caption := 'Contado';
        if _IdFormaPago = 5 then
          pnlEstado3.Caption := 'Crédito';
        pnlEstado1.Caption := 'Número: ' + IntToStr(_Numero);
      end;
    except
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
        PostMessage(Handle, WM_CLOSE, 0, 0);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure FinalizarForma;
begin
  with Forma01 do
  begin

    try
      _DL_TB_FACTURASDETALLEActual.Destroy;
    except
    end;

  end;
end;

procedure KeyDownForma(var Key: Word; Shift: TShiftState);
begin
  with Forma01 do
  begin

    if Key = VK_ESCAPE then
    begin
      Key := 0;
      Close;
    end;
    if Key = VK_F2 then
    begin
      Key := 0;
      btnNuevo.Click;
    end;
    if (Key = VK_F3) and (btnPagar.Enabled = True) then
    begin
      Key := 0;
      btnPagar.Click;
    end;
    if (Key = VK_F4) and (btnAnular.Enabled = True) then
    begin
      Key := 0;
      btnAnular.Click;
    end;
    if (Key = VK_F5) and (btnImprimir.Enabled = True) then
    begin
      Key := 0;
      Imprimir1.Click;
    end;
    if (Key = VK_F6) and (pnlDetalle.Enabled = True) then
    begin
      Key := 0;
      btnInsertarLinea.Click;
    end;
    if (Key = VK_F7) and (pnlDetalle.Enabled = True) then
    begin
      Key := 0;
      edtCodigoProducto.OnRightButtonClick(edtCodigoProducto);
    end;
    if (Key = VK_F8) and (pnlDetalle.Enabled = True) then
    begin
      Key := 0;
      edtProductoNombre.OnRightButtonClick(edtProductoNombre);
    end;
    if (Key = VK_F9) and (pnlDetalle.Enabled = True) then
    begin
      Key := 0;
      edtCodigoProducto.SetFocus;
    end;
    if (Key = VK_F10) and (pnlDetalle.Enabled = True) then
    begin
      Key := 0;
      edtCodigoBarras.SetFocus;
    end;
    if (Key = (ord('T') Or ord('t'))) and (Shift = [ssCtrl]) then
    begin
      Key := 0;
      lvLista1.SetFocus;
    end;
    if (Key = VK_DOWN) and (btnPagar.Enabled = True) then
      Pagar_DataDefault;
    if (Key = vk_Add) and (btnPagar.Enabled = True) then
      Sumar;
    if (Key = VK_SUBTRACT) and (btnPagar.Enabled = True) then
      Restar;
  end;
end;

procedure LimpiarCampos;
begin
  with Forma01 do
  begin

    LimpiarCampos_Titulo;
    LimpiarCampos_Encabezado;
    LimpiarCampos_DetalleCampos;
    LimpiarCampos_DetalleLista;
    LimpiarCampos_Pie;

  end;
end;

procedure LimpiarCampos_Titulo;
begin
  with Forma01 do
  begin

    pnlTitulo2.Caption := '';
    pnlEstado1.Caption := 'Número: ';
    dtpFecha.Date := Date;
    pnlEstado3.Caption := '';
    pnlEstado4.Caption := '';
    pnlTotal.Caption := '0';
    imgAnulado.Visible := False;

  end;
end;

procedure LimpiarCampos_Encabezado;
begin
  with Forma01 do
  begin

    cbCliente.ItemIndex := 0;
    cbVendedor.ItemIndex := SetCombo(cbVendedor,
      Global.IdVendedorDefault);
    edtLimiteCredito.Value := 0;
    lblFechaVencimiento.Visible := False;

  end;
end;

procedure LimpiarCampos_DetalleCampos;
begin
  with Forma01 do
  begin

    _IdProducto := 0;
    edtCodigoProducto.Clear;
    edtCodigoBarras.Clear;
    edtCantidad.Value := 1;
    edtDescuento.Value := 0;
    edtProductoNombre.Clear;
    edtPrecio.Value := 0;
    edtExistencia.Value := 0;
    edtDescripcion1.Clear;
    edtDescripcion2.Clear;

  end;
end;

procedure LimpiarCampos_DetalleLista;
begin
  with Forma01 do
  begin

    chkTodoLista1.Checked := False;
    lvLista1.Items.Clear;

  end;
end;

procedure LimpiarCampos_Pie;
begin
  with Forma01 do
  begin

    pnlSubTotal.Caption := '0';
    pnlDescuento.Caption := '0';
    pnlServicio.Caption := '0';
    pnlImpuesto.Caption := '0';
    if Global.AplicarImpuestoServicio = 1 then
      pnlServicio.Visible := True
    else
      pnlServicio.Visible := False;

  end;
end;

procedure Insertar_Detalle;
var
  mProductos: TDL_TB_PRODUCTOS;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mCantidadAnterior, mCantidad, mPrecio, mPrecioDescuento, mPrecioServicio, mPrecioFinal, mMonto: Double;
  mDescuentoP, mDescuentoPM, mDescuentoM: Double;
  mServicioPM, mServicioM: Double;
  mIVAPorcentaje, mIVAPM, mIVAM: Double;
  mEncontrado: Boolean;
  mTipo, mAplicarImpuesto, mAplicarDescuento: Integer;
  mKilos: Double;
  mIdComanda: Integer;
  mCodigoBarras: string;
  mLinea, mLineaCount: Integer;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      CamposValidos_Detalle;
      if _Resultado = 0 then
        raise Exception.Create('');

      mAplicarImpuesto := 1;
      if GetCombo(cbCliente) > 0 then
      begin
        mWhere := TStringList.Create;
        mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mAplicarImpuesto :=
          mDL_TB_CLIENTES.Obtener_Valor(mWhere.Text, 'APLICARIMPUESTO',
          _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_CLIENTES.Destroy;
      end;

      mWhere := TStringList.Create;
      mWhere.Add('Id=' + IntToStr(_IdProducto));
      mProductos := TDL_TB_PRODUCTOS.Create;
      mTipo :=
        mProductos.Obtener_Valor(mWhere.Text, 'IdTipo',
        _Resultado, _ErrorM);
      mKilos :=
        mProductos.Obtener_Valor(mWhere.Text, 'Peso',
        _Resultado, _ErrorM);
      mAplicarDescuento :=
        mProductos.Obtener_Valor(mWhere.Text, 'PERMITIRDESCUENTOS',
        _Resultado, _ErrorM);
      mIdComanda :=
        mProductos.Obtener_Valor(mWhere.Text, 'CODIGOCOMANDA',
        _Resultado, _ErrorM);
      mCodigoBarras :=
        mProductos.Obtener_Valor(mWhere.Text, 'CODIGOBARRAS',
        _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      mProductos.Destroy;

      mCantidadAnterior := 0;
      mEncontrado :=
        _DL_TB_FACTURASDETALLEActual.Dataset.Locate('IdProducto', _IdProducto, []);
      if mEncontrado = True then
        mCantidadAnterior :=
          _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('Cantidad').AsFloat;

      mCantidad := edtCantidad.Value + mCantidadAnterior;
      mKilos := mKilos * mCantidad;
      if mTipo = 1 then
      begin
        if mCantidad > edtExistencia.Value then
        begin
          _ErrorM := 'Existencia insuficiente';
          _Resultado := 0;
          raise Exception.Create('');
        end;
      end;
      mPrecio := edtPrecio.Value;

      // Calcula el Descuento
      mDescuentoPM := 0;
      mDescuentoP := edtDescuento.Value;
      if mDescuentoP <> 0 then
        mDescuentoPM := mDescuentoP / 100;
      mDescuentoM := (mPrecio * mDescuentoPM) * mCantidad;
      mPrecioDescuento := mPrecio - (mPrecio * mDescuentoPM);

      // Calcula el Servicio
      if Global.AplicarImpuestoServicio = 1 then
      begin
        mServicioPM := 0;
        if Global.ImpuestoServicio <> 0 then
          mServicioPM := Global.ImpuestoServicio / 100;
        mServicioM := (mPrecioDescuento * mServicioPM) * mCantidad;
      end;
      mPrecioServicio := mPrecioDescuento;

      // Obtener Impuesto Porcentaje
      if mAplicarImpuesto = 1 then
      begin
        mIVAPorcentaje := 0;
        mWhere := TStringList.Create;
        mWhere.Add('A.Id=' + IntToStr(_IdProducto));
        mProductos := TDL_TB_PRODUCTOS.Create;
        mIVAPorcentaje :=
          mProductos.Obtener_ImpuestoPorcentaje(mWhere.Text,
          _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mProductos.Destroy;

        // Calcula el Impuesto
        mIVAPM := 0;
        if mIVAPorcentaje <> 0 then
          mIVAPM := mIVAPorcentaje / 100;
        mIVAM := (mPrecioServicio * mIVAPM) * mCantidad;
      end;
      mPrecioFinal := mPrecioServicio;

      mMonto := mPrecioFinal * mCantidad;

      // Llena el DataSet
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        Last;
        mLineaCount :=
          FieldByName('Linea').AsInteger;
        if mEncontrado = True then
          Edit;
        if mEncontrado = False then
        begin
          First;
          Insert;
         // Append;
          mLinea := mLineaCount + 1;
          FieldByName('Linea').AsInteger :=
            mLinea;
        end;
        FieldByName('CODIGO').Tag := 1;
        FieldByName('CODIGO').AsString :=
          edtCodigoProducto.Text;
        FieldByName('NOMBRE').Tag := 1;
        FieldByName('NOMBRE').AsString :=
          edtProductoNombre.Text;
        FieldByName('CANTIDAD').Tag := 1;
        FieldByName('CANTIDAD').AsFloat :=
          mCantidad;
        FieldByName('PRECIOUNITARIO').Tag := 1;
        FieldByName('PRECIOUNITARIO').AsFloat :=
          mPrecio;
        FieldByName('DESCUENTOP').Tag := 1;
        FieldByName('DESCUENTOP').AsFloat :=
          mDescuentoP;
        FieldByName('DESCUENTOM').Tag := 1;
        FieldByName('DESCUENTOM').AsFloat :=
          mDescuentoM;
        FieldByName('IVAP').Tag := 1;
        FieldByName('IVAP').AsFloat :=
          mIVAPorcentaje;
        FieldByName('IVAM').Tag := 1;
        FieldByName('IVAM').AsFloat :=
          mIVAM;
        FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
        FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
          mPrecioFinal;
        FieldByName('PRECIOFINAL').Tag := 1;
        FieldByName('PRECIOFINAL').AsFloat :=
          mMonto;
        FieldByName('LINEA').Tag := 1;
        FieldByName('LINEA').AsInteger := 0;
        FieldByName('PRECIOMAYORISTAAPLICADO').Tag := 1;
        FieldByName('PRECIOMAYORISTAAPLICADO').AsInteger := 0;
        FieldByName('ISP').Tag := 1;
        FieldByName('ISP').AsFloat :=
          Global.ImpuestoServicio;
        FieldByName('ISM').Tag := 1;
        FieldByName('ISM').AsFloat :=
          mServicioM;
        FieldByName('PRECIOUNITARIOBASE').Tag := 1;
        FieldByName('PRECIOUNITARIOBASE').AsFloat := 0;
        FieldByName('PRECIOFINALBASE').Tag := 1;
        FieldByName('PRECIOFINALBASE').AsFloat := 0;
        FieldByName('DESCRIPCION1').Tag := 1;
        FieldByName('DESCRIPCION1').AsString :=
          edtDescripcion1.Text;
        FieldByName('DESCRIPCION2').Tag := 1;
        FieldByName('DESCRIPCION2').AsString :=
          edtDescripcion2.Text;
        FieldByName('IdProducto').Tag := 1;
        FieldByName('IdProducto').AsInteger :=
          _IdProducto;
        FieldByName('TOTALKILOS').Tag := 1;
        FieldByName('TOTALKILOS').AsFloat :=
          mKilos;
        FieldByName('IdComanda').AsInteger :=
          mIdComanda;
        FieldByName('CODIGOBARRAS').AsString :=
          mCodigoBarras;
        Post;
      end;

      // Actualiza linea
      mLineaCount :=
        _DL_TB_FACTURASDETALLEActual.Dataset.RecordCount;
      mLinea := mLineaCount;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          Edit;
          FieldByName('LINEA').AsInteger :=
            mLinea;
          Post;
          Dec(mLinea);
          Next;
        end;
      end;

      LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
      ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
      LimpiarCampos_DetalleCampos;

      _Resultado := 1;
    except
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure Eliminar_Detalle;
var
  mFila: Integer;
  mLinea: string;
  mIdProducto: Integer;
  mEncontrado: Boolean;
  mLineaN, mLineaCount: Integer;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      for mFila := 0 to lvLista1.Items.Count - 1 do
      begin
        if lvLista1.Items[mFila].Checked = True then
        begin
          mLinea := lvLista1.Items[mFila].SubItems[5];
          try
            mIdProducto := StrToInt(mLinea);
          except
            mIdProducto := 0;
          end;
          mEncontrado :=
            _DL_TB_FACTURASDETALLEActual.Dataset.Locate('IdProducto', mIdProducto, []);
          if mEncontrado = True then
            _DL_TB_FACTURASDETALLEActual.Dataset.Delete;
        end;
      end;

      // Actualiza linea
      mLineaCount :=
        _DL_TB_FACTURASDETALLEActual.Dataset.RecordCount;
      mLineaN := mLineaCount;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          Edit;
          FieldByName('Linea').AsInteger :=
            mLineaN;
          Post;
          Dec(mLineaN);
          Next;
        end;
      end;

      LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
      ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);

      _Resultado := 1;
    except
      _Resultado := -1;
    end;

    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure LlenarlvLista1(lv: TRzListView; ds1: TDatasetMem);
begin
  with Forma01 do
  begin

    lv.Items.Clear;

    with ds1 do
    begin
      RzStatusPane1.Caption := 'Registros: ' +
        FormatFloat('#,##0', RecordCount);
      First;
      while not Eof do
      begin
        with lv.Items.Add do
        begin
          Caption := '';
          SubItems.Add(
            FieldByName('CODIGO').AsString);
          SubItems.Add(
            FieldByName('NOMBRE').AsString);
          SubItems.Add(
            FormatFloat('#,##0.00',
            FieldByName('CANTIDAD').AsFloat));
          SubItems.Add(
            FormatFloat('#,##0.00',
            FieldByName('PRECIOUNITARIO').AsFloat));
          SubItems.Add(
            FormatFloat('#,##0.00',
            FieldByName('PRECIOFINAL').AsFloat));
          SubItems.Add(
            FieldByName('IdProducto').AsString);
          SubItems.Add(
            FieldByName('ID').AsString);
          SubItems.Add(
            FieldByName('DESCRIPCION1').AsString);
          SubItems.Add(
            FieldByName('DESCRIPCION2').AsString);
          SubItems.Add(
            FieldByName('CODIGOBARRAS').AsString);
        end;
        Next;
      end;
    end;

  end;
end;

procedure Buscar_ProductoCodigo(pTexto: string);
var
  mBS_Productos: TDL_TB_PRODUCTOS;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mTexto: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;
      mTexto := Trim(pTexto);

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mBS_Productos := TDL_TB_PRODUCTOS.Create;
      mWhere := TStringList.Create;
      mWhere.Add('Upper(A.CODIGO)=Upper(' + QuotedStr(mTexto) + ')');
      mBS_Productos.Consultar(_Resultado, _ErrorM, mWhere.Text, '');
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;
      DBToFormaDetalle(mBS_Productos.Dataset);
      with mBS_Productos.Dataset do
      begin
        if IsEmpty = False then
          edtCodigoBarras.Text :=
            FieldByName('CODIGOBARRAS').AsString;
      end;
      mBS_Productos.Destroy;

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      _Resultado := -1;
    end;

    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure Buscar_ProductoCodigoBarras(pTexto: string);
var
  mBS_Productos: TDL_TB_PRODUCTOS;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mTexto: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;
      mTexto := Trim(pTexto);

      if mTexto <> '' then
      begin
        _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

        mBS_Productos := TDL_TB_PRODUCTOS.Create;
        mWhere := TStringList.Create;
        mWhere.Add('A.CODIGOBARRAS=' + QuotedStr(mTexto));
        mBS_Productos.Consultar(_Resultado, _ErrorM, mWhere.Text, '');
        if _Resultado = -1 then
          raise Exception.Create('');
        mWhere.Free;
        DBToFormaDetalle(mBS_Productos.Dataset);
        with mBS_Productos.Dataset do
        begin
          if IsEmpty = False then
            edtCodigoProducto.Text :=
              FieldByName('CODIGO').AsString;
        end;
        mBS_Productos.Destroy;

        _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);
      end;

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      _Resultado := -1;
    end;

//    if Global.CodigoBarrasDirecto = 1 then
 //     edtCodigoBarras.SetFocus;

  end;
end;

procedure DBToFormaDetalle(ds1: TDatasetMem);
begin
  with Forma01 do
  begin

    with ds1 do
    begin
      _IdProducto :=
        FieldByName('Id').AsInteger;

      edtProductoNombre.Text :=
        FieldByName('Nombre').AsString;
      edtPrecio.Value :=
        FieldByName('PRECIOVENTA').AsFloat;
      edtExistencia.Value :=
        FieldByName('EXISTENCIA').AsFloat;
    end;

  end;
end;

procedure ActualizarTotales(ds1: TDatasetMem);
var
  mSubTotal, mDescuento, mServicio, mImpuesto, mTotal: Double;
  mIdCliente: Integer;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mPrecio, mCantidad: Double;
  mDescuentoCPor, mDescuentoCPM, mDescuentoCM, mPrecioCDescuento,
    TotalDescuentos: Double;
  mAplicarDescuento: Integer;
  mProductos: TDL_TB_PRODUCTOS;
begin
  with Forma01 do
  begin

    mSubTotal := 0;
    mDescuento := 0;
    mServicio := 0;
    mImpuesto := 0;
    mTotal := 0;

    mDescuentoCPor := 0;
    mDescuentoCM := 0;
    mIdCliente := GetCombo(cbCliente);
    if GetCombo(cbCliente) > 0 then
    begin
      mWhere := TStringList.Create;
      mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
      mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
      mDescuentoCPor :=
        mDL_TB_CLIENTES.Obtener_Valor(mWhere.Text, 'DescuentoPor',
        _Resultado, _ErrorM);
      mWhere.Free;
      mDL_TB_CLIENTES.Destroy;
    end;

    with ds1 do
    begin
      First;
      while not Eof do
      begin
        mPrecio :=
          FieldByName('PRECIOUNITARIO').AsFloat;
        mCantidad :=
          FieldByName('Cantidad').AsFloat;

        mAplicarDescuento := 0;

        mWhere := TStringList.Create;
        mWhere.Add('Id=' + FieldByName('IdProducto').AsString);
        mProductos := TDL_TB_PRODUCTOS.Create;
        mAplicarDescuento :=
          mProductos.Obtener_Valor(mWhere.Text, 'PERMITIRDESCUENTOS',
          _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mProductos.Destroy;

        // Calcula el Descuento
        mDescuentoCPM := 0;
        if mAplicarDescuento = 1 then
        begin
          if mDescuentoCPor <> 0 then
            mDescuentoCPM := mDescuentoCPor / 100;
          mDescuentoCM := (mPrecio * mDescuentoCPM) * mCantidad;
          mPrecioCDescuento := mPrecio - (mPrecio * mDescuentoCM);
          mDescuento := mDescuento + mDescuentoCM;
        end;

        mSubTotal := mSubTotal +
          FieldByName('PRECIOFINAL').AsFloat;
        mDescuento := mDescuento +
          FieldByName('DESCUENTOM').AsFloat;
        if _Origen = 1 then
          mServicio := mServicio +
            FieldByName('ISM').AsFloat;
        mImpuesto := mImpuesto +
          FieldByName('IVAM').AsFloat;

        Next;
      end;
    end;

    //mDescuentoCM := (mSubTotal * mDescuentoCPM);

    //mTotal := (mSubTotal - mDescuento) + mServicio + mImpuesto;
    mTotal := (mSubTotal) + mServicio + mImpuesto;

    //mDescuento := mDescuento + mDescuentoCM;
    pnlSubTotal.Caption :=
      FormatFloat('#,##0.00', mSubTotal);
    pnlDescuento.Caption :=
      FormatFloat('#,##0.00', mDescuento);
    pnlServicio.Caption :=
      FormatFloat('#,##0.00', mServicio);
    pnlImpuesto.Caption :=
      FormatFloat('#,##0.00', mImpuesto);

    _SubTotal := mSubTotal;
    _DescuentoM := mDescuento;
    _IVAM := mImpuesto;
    _ISM := mServicio;
    if Global.APLICARREDONDEO = 1 then
      mTotal := Round(mTotal);
    if Global.APLICARREDONDEO5 = 1 then
      mTotal := Round(mTotal / 5) * 5;

    _Total := mTotal;

    pnlTotal.Caption :=
      FormatFloat('#,##0.00', mTotal);

  end;
end;

procedure LlenarcbClientes(cb: TComboBoxEx);
var
  mDL_TB_Clientes: TDL_TB_CLIENTES;
  mWhere, mOrderBy: TStringList;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      cb.Items.Clear;
      cb.Items.AddObject('[SIN SELECCIONAR]', TObject(0));

      mWhere := TStringList.Create;
      mOrderBy := TStringList.Create;
      mOrderBy.Add('A.NOMBRECOMPLETO');
      mDL_TB_Clientes := TDL_TB_CLIENTES.Create;
      mDL_TB_Clientes.Consultar(_Resultado, _ErrorM,
        mWhere.Text, mOrderBy.Text);
      mWhere.Free;
      mOrderBy.Free;
      with mDL_TB_Clientes.Dataset do
      begin
        First;
        while not Eof do
        begin
          cb.Items.AddObject(
            FieldByName('CODIGO').AsString + ' ' +
            FieldByName('NOMBRECOMPLETO').AsString,
            TObject(FieldByName('Id').AsInteger));
          Next;
        end;
      end;
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_Clientes.Destroy;

      _Resultado := 1;
    except
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure LlenarcbVendedores(cb: TComboBoxEx);
var
  mDL_TB_Vendedores: TDL_TB_VENDEDORES;
  mWhere, mOrderBy: TStringList;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      cb.Items.Clear;
      cb.Items.AddObject('[SIN SELECCIONAR]', TObject(0));

      mWhere := TStringList.Create;
      mOrderBy := TStringList.Create;
      mOrderBy.Add('A.NOMBRECOMPLETO');
      mDL_TB_Vendedores := TDL_TB_VENDEDORES.Create;
      mDL_TB_Vendedores.Consultar(_Resultado, _ErrorM,
        mWhere.Text, mOrderBy.Text);
      mWhere.Free;
      mOrderBy.Free;
      with mDL_TB_Vendedores.Dataset do
      begin
        First;
        while not Eof do
        begin
          cb.Items.AddObject(
            FieldByName('NOMBRECOMPLETO').AsString,
            TObject(FieldByName('Id').AsInteger));
          Next;
        end;
      end;
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_Vendedores.Destroy;

      _Resultado := 1;
    except
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure Consultar_Cliente(pId: Integer);
var
  mBS_Clientes: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mBS_Clientes := TDL_TB_CLIENTES.Create;
      mWhere := TStringList.Create;
      mWhere.Add('A.Id=' + IntToStr(pId));
      mBS_Clientes.Consultar(_Resultado, _ErrorM, mWhere.Text, '');
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;
      with mBS_Clientes.Dataset do
      begin
        if IsEmpty = False then
        begin
          edtLimiteCredito.Value :=
            FieldByName('LIMITECREDITO').AsFloat;
        end;
      end;
      mBS_Clientes.Destroy;

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      _Resultado := -1;
    end;

  end;
end;

procedure MDLista_Todos(lv: TRzListView; chk: TCheckBox);
var
  mFila: Integer;
begin
  with Forma01 do
  begin

    for mFila := 0 to lv.Items.Count - 1 do
      lv.Items[mFila].Checked := chk.Checked;

  end;
end;

procedure Nuevo;
begin
  with Forma01 do
  begin

    InicializarForma;

  end;
end;

procedure Pagar_Data;
var
  Aux01: Integer;
  mDL_TB_FACTURASCLIENTESENCABEZADO: Clase_Tipo1;
  mDL_TB_CONSECUTIVOS: TDL_TB_CONSECUTIVOS;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mNumero: Integer;
  mNombreCliente, mNombreVendedor: string;
  mFechaVencimiento: TDateTime;
  mDL_TB_OrdenesEncabezado: TDL_TB_OrdenesEncabezado;
  mDL_TB_OrdenesDetalle: TDL_TB_OrdenesDetalle;
  mClienteTipoPago, mClientePlazo: Integer;
  mDL_TB_AsientosEncabezado: TDL_TB_AsientosEncabezado;
  mDL_TB_AsientosDetalle: TDL_TB_AsientosDetalle;
  mIdAsiento: Integer;
  mbs_DBGeneral: tbs_DBGeneral;
  mTotalExcento, mTotalGravado, mKilos: Double;
  DL_TB_PLANTILLAS: TDL_TB_PLANTILLAS;
  mArchivo: TStringList;
  mNombreArchivo: string;
  mDL_TB_EMPRESAS: TDL_TB_EMPRESAS;
  mDL_TB_DOCUMENTOSHACIENDA: TDL_TB_DOCUMENTOSHACIENDA;
  mFecha: TDate;
  mConsecutivo, mClave, mYearS, mMonthS, mDayS, mIdentificacion: string;
  mYear, mMonth, mDay: Word;
  mFechaEmision, mCondicionVenta, mPlazoCredito, mMedioPago: string;
  mXMLSinFirma: string;
  mtb_docunentosencabezado: TDL_tb_docunentosencabezado;
  mtb_docunentosdetalle: TDL_tb_docunentosdetalle;
  mtb_documentosdescuentos: TDL_tb_documentosdescuentos;
  mtb_docunentosimpuestos: TDL_tb_docunentosimpuestos;
  mtb_documentosotroscargos: TDL_tb_documentosotroscargos;
  mtb_empresasHacienda: TDL_tb_empresas2;
  mServiciosExentos, mServiciosGravados, mMercanciasExentos, mMercanciasGravados: Double;
  mTotalVenta, mTotalVentaNeta, mTotalImpuesto, mTotalComprobante, mTotalDescuentos: Double;
  mIdSituacion, mNumeroLinea, mIdHacienda: Integer;
  mRespuestaHacienda: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      CamposValidos_Pagar1;
      if _Resultado = 0 then
        raise Exception.Create('');

      FormPagar01._PasaForma := False;
      FormPagar01._TipoPago := 1;
      FormPagar01.pnlCredito.Visible := True;
      FormPagar01._Total := _Total;
      FormPagar01._Plazo := Global.DiasVencimientoDefault;

      if GetCombo(cbCliente) > 0 then
      begin
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mClienteTipoPago :=
          mDL_TB_CLIENTES.Obtener_Valor('Id=' + IntToStr(GetCombo(cbCliente)),
            'TIPOPAGO', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mClientePlazo :=
          mDL_TB_CLIENTES.Obtener_Valor('Id=' + IntToStr(GetCombo(cbCliente)),
            'PLAZO', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');

        mDL_TB_CLIENTES.Destroy;

        if mClienteTipoPago = 2 then
        begin
          FormPagar01._TipoPago := 2;
          FormPagar01._Plazo := mClientePlazo;
        end;
      end;

      FormPagar01.ShowModal;
      if FormPagar01.Tag = 0 then
      begin
        _Resultado := 1;
        raise Exception.Create('');
      end;
      mFechaVencimiento := IncDay(dtpFecha.Date, FormPagar01._Plazo);
      lblFechaVencimiento.Caption := FormatDateTime('dd/MM/yyyy',
        mFechaVencimiento);
      if FormPagar01._IDFormaPago = 5 then
        lblFechaVencimiento.Visible := True
      else
        lblFechaVencimiento.Visible := False;
      if FormPagar01._IDFormaPago = 1 then
      begin
        _IdEstado := 2;
        mCondicionVenta := '01';
        mPlazoCredito := '0';
      end;
      if FormPagar01._IDFormaPago = 5 then
      begin
        _IdEstado := 4;
        mCondicionVenta := '02';
        mPlazoCredito := '30';
      end;
      _IdFormaPago := FormPagar01._IDFormaPago;
      case FormPagar01._MedioPago of
        1: mMedioPago := '01';
        2: mMedioPago := '02';
        3: mMedioPago := '03';
        4: mMedioPago := '04';
      end;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      CamposValidos_Pagar2;
      if _Resultado = 0 then
        raise Exception.Create('');

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mNumero :=
        mDL_TB_CONSECUTIVOS.Obtener_Valor('', 'FACTURASCLIENTES',
      _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;
      Inc(mNumero);

      if Trim(cbCliente.Text)  = '[SIN SELECCIONAR]' then
        mNombreCliente := ''
      else
        mNombreCliente := Trim(cbCliente.Text);
      if Trim(cbVendedor.Text)  = '[SIN SELECCIONAR]' then
        mNombreVendedor := ''
      else
        mNombreVendedor := Trim(cbVendedor.Text);

      // Varios
      mTotalExcento := 0;
      mTotalGravado := 0;
      mKilos := 0;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          if FieldByName('IVAM').AsFloat <> 0 then
            mTotalExcento := mTotalExcento +
              FieldByName('PRECIOFINAL').AsFloat
          else
            mTotalGravado := mTotalGravado +
              FieldByName('PRECIOFINAL').AsFloat;
          mKilos := mKilos +
            FieldByName('TOTALKILOS').AsFloat;
          Next;
        end;
      end;

      // Encabezado
      mDL_TB_FACTURASCLIENTESENCABEZADO := Clase_Tipo1.Create;
      with mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset do
      begin
        EmptyDataSet;
        mDL_TB_FACTURASCLIENTESENCABEZADO.Limpiar_Tag;
        Append;
        FieldByName('NUMERO').Tag := 1;
        FieldByName('NUMERO').AsInteger :=
          mNumero;
        FieldByName('FECHA').Tag := 1;
        FieldByName('FECHA').AsString :=
          FormatDateTime('dd/MM/yyyy', dtpFecha.Date);
        FieldByName('HORA').Tag := 1;
        FieldByName('HORA').AsString :=
          FormatDateTime('HH:mm:ss', Time);
        FieldByName('CODIGOMESA').Tag := 1;
        FieldByName('CODIGOMESA').AsInteger := 0;
        FieldByName('NUMEROMESA').Tag := 1;
        FieldByName('NUMEROMESA').AsString := '';
        FieldByName('NOMBRECLIENTE').Tag := 1;
        FieldByName('NOMBRECLIENTE').AsString :=
          mNombreCliente;
        FieldByName('SUBTOTAL').Tag := 1;
        FieldByName('SUBTOTAL').AsFloat :=
          _SubTotal;
        FieldByName('DESCUENTOP').Tag := 1;
        FieldByName('DESCUENTOP').AsFloat := 0;
        FieldByName('DESCUENTOM').Tag := 1;
        FieldByName('DESCUENTOM').AsFloat :=
          _DescuentoM;
        FieldByName('IVAP').Tag := 1;
        FieldByName('IVAP').AsFloat := 0;
        FieldByName('IVAM').Tag := 1;
        FieldByName('IVAM').AsFloat :=
          _IVAM;
        FieldByName('ISP').Tag := 1;
        FieldByName('ISP').AsFloat := 0;
        FieldByName('ISM').Tag := 1;
        FieldByName('ISM').AsFloat :=
          _ISM;
        FieldByName('TRANSPORTE').Tag := 1;
        FieldByName('TRANSPORTE').AsFloat := 0;
        FieldByName('TOTAL').Tag := 1;
        FieldByName('TOTAL').AsFloat :=
          _Total;
        FieldByName('TOTALGRAVADO').Tag := 1;
        FieldByName('TOTALGRAVADO').AsFloat :=
          mTotalGravado;
        FieldByName('TOTALEXCENTO').Tag := 1;
        FieldByName('TOTALEXCENTO').AsFloat :=
          mTotalExcento;
        FieldByName('CODIGOESTADO').Tag := 1;
        FieldByName('CODIGOESTADO').AsInteger :=
          _IdEstado;
        FieldByName('CODIGOFORMAPAGO').Tag := 1;
        FieldByName('CODIGOFORMAPAGO').AsInteger :=
          FormPagar01._IDFormaPago;
        FieldByName('FECHAVENCIMIENTO').Tag := 1;
        FieldByName('FECHAVENCIMIENTO').AsString :=
          FormatDateTime('dd/MM/yyyy', mFechaVencimiento);
        FieldByName('CODIGOTIPO').Tag := 1;
        FieldByName('CODIGOTIPO').AsInteger := 1;
        FieldByName('SALDO').Tag := 1;
        FieldByName('SALDO').AsFloat :=
          FormPagar01._CreditoTotal;
        FieldByName('NOMBREVENDEDOR').Tag := 1;
        FieldByName('NOMBREVENDEDOR').AsString :=
          mNombreVendedor;
        FieldByName('NUMEROPROFORMA').Tag := 1;
        FieldByName('NUMEROPROFORMA').AsInteger := 0;
        FieldByName('PAGOCON').Tag := 1;
        FieldByName('PAGOCON').AsFloat :=
          FormPagar01._Pagado;
        FieldByName('CAMBIO').Tag := 1;
        FieldByName('CAMBIO').AsFloat :=
          FormPagar01._Cambio;
        FieldByName('EFECTIVO').Tag := 1;
        FieldByName('EFECTIVO').AsFloat :=
          FormPagar01._EfectivoTotal;
        FieldByName('TARJETA').Tag := 1;
        FieldByName('TARJETA').AsFloat :=
          FormPagar01._TarjetaTotal;
        FieldByName('TRANSFERENCIA').Tag := 1;
        FieldByName('TRANSFERENCIA').AsFloat :=
          FormPagar01._TransferenciaTotal;
        FieldByName('CHEQUE').Tag := 1;
        FieldByName('CHEQUE').AsFloat :=
          FormPagar01._ChequeTotal;
        FieldByName('IdCliente').Tag := 1;
        FieldByName('IdCliente').AsInteger :=
          GetCombo(cbCliente);
        FieldByName('IdVendedor').Tag := 1;
        FieldByName('IdVendedor').AsInteger :=
          GetCombo(cbVendedor);
        FieldByName('NUMERONotaCredito').Tag := 1;
        FieldByName('NUMERONotaCredito').AsInteger := 0;
        FieldByName('Kilos').Tag := 1;
        FieldByName('Kilos').AsFloat :=
          mKilos;
        Post;
      end;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mDL_TB_CONSECUTIVOS.Actualizar_Campo('', 'FACTURASCLIENTES', mNumero,
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;

      // Detalle
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          Edit;
          FieldByName('NUMERO').Tag := 1;
          FieldByName('NUMERO').AsInteger :=
            mNumero;
          FieldByName('CODIGOESTADO').Tag := 1;
          FieldByName('CODIGOESTADO').AsInteger := 2;
          Post;
          Next;
        end;
      end;
      _DL_TB_FACTURASDETALLEActual.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      // Actualizar Existencias
      mWhere := TStringList.Create;
      mWhere.Add('Numero=' + IntToStr(mNumero));
      _DL_TB_FACTURASDETALLEActual.Restar_Existencias(mWhere.Text,
        _DL_TB_FACTURASDETALLEActual.DataSet, _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;

      // Actualiza Saldo Cliente
      if FormPagar01._IDFormaPago = 5 then
      begin
        mWhere := TStringList.Create;
        mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mDL_TB_CLIENTES.Sumar_Saldo(mWhere.Text,
          FormPagar01._CreditoTotal, _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_CLIENTES.Destroy;
      end;

      // Hacienda
      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mIdentificacion :=
        mDL_TB_EMPRESAS.Obtener_Valor('', 'CEDULA', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
      mDL_TB_EMPRESAS.Destroy;
      mIdentificacion := Copy(mIdentificacion, 1, 12);

     // mConsecutivo := GetConsecutivo(Global.Sucursal, Global.Terminal, '1', mNumero);
      DecodeDate(dtpFecha.Date, mYear, mMonth, mDay);
      try
        mYearS := IntToStr(mYear);
        mYearS := copy(mYearS, 3, 2);
      except
        mYearS := '00';
      end;
      try
        mMonthS := IntToStr(mMonth);
        if Length(mMonthS)  = 1 then
          mMonthS := '0' + mMonthS;
      except
        mMonthS := '01';
      end;
      try
        mDayS := IntToStr(mDay);
        if Length(mDayS)  = 1 then
          mDayS := '0' + mDayS;
      except
        mDayS := '01';
      end;
     // mClave := GetClave(dtpFecha.Date, mConsecutivo, '1', mIdentificacion, '99999999');
      mDL_TB_DOCUMENTOSHACIENDA := TDL_TB_DOCUMENTOSHACIENDA.Create;
      with mDL_TB_DOCUMENTOSHACIENDA.Dataset do
      begin
        mDL_TB_DOCUMENTOSHACIENDA.Limpiar_Tag;
        EmptyDataSet;
        Append;
        FieldByName('IDENCABEZADO').Tag := 1;
        FieldByName('IDENCABEZADO').AsInteger := mNumero;
        FieldByName('SUCURSAL').Tag := 1;
        FieldByName('SUCURSAL').AsString := Global.Sucursal;
        FieldByName('TERMINAL').Tag := 1;
        FieldByName('TERMINAL').AsString := Global.Terminal;
        FieldByName('TIPO').Tag := 1;
        FieldByName('TIPO').AsString := '1';
        FieldByName('NUMERACION').Tag := 1;
        FieldByName('NUMERACION').AsString := IntToStr(mNumero);
        FieldByName('CONSECUTIVO').Tag := 1;
        FieldByName('CONSECUTIVO').AsString := mConsecutivo;
        FieldByName('PAIS').Tag := 1;
        FieldByName('PAIS').AsString := '506';
        FieldByName('DIA').Tag := 1;
        FieldByName('DIA').AsString := mDayS;
        FieldByName('MES').Tag := 1;
        FieldByName('MES').AsString := mMonthS;
        FieldByName('MYEAR').Tag := 1;
        FieldByName('MYEAR').AsString := mYearS;
        FieldByName('IDENTIFICACION').Tag := 1;
        FieldByName('IDENTIFICACION').AsString := mIdentificacion;
        FieldByName('SITUACION').Tag := 1;
        FieldByName('SITUACION').AsString := '1';
        FieldByName('SEGURIDAD').Tag := 1;
        FieldByName('SEGURIDAD').AsString := '99999999';
        FieldByName('CLAVE').Tag := 1;
        FieldByName('CLAVE').AsString := mClave;
        FieldByName('MQR').Tag := 1;
        FieldByName('MQR').AsString := mClave;
        Post;
      end;
      mDL_TB_DOCUMENTOSHACIENDA.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_DOCUMENTOSHACIENDA.Destroy;

      // Ordenes
      mDL_TB_OrdenesEncabezado := TDL_TB_OrdenesEncabezado.Create;
      with mDL_TB_OrdenesEncabezado.Dataset do
      begin
        mDL_TB_OrdenesEncabezado.Limpiar_Tag;
        EmptyDataSet;
        Append;
        FieldByName('ETIQUETA').Tag := 1;
        FieldByName('ETIQUETA').AsString := '';
        FieldByName('VENTA').Tag := 1;
        FieldByName('VENTA').AsFloat := 0;
        FieldByName('COMENTARIOS').Tag := 1;
        FieldByName('COMENTARIOS').AsString := '';
        FieldByName('IDCLIENTE').Tag := 1;
        FieldByName('IDCLIENTE').AsInteger := 0;
        FieldByName('FECHA').Tag := 1;
        FieldByName('FECHA').AsDateTime := Date;
        FieldByName('HORA').Tag := 1;
        FieldByName('HORA').AsString := '';
        FieldByName('CODIGOESTADO').Tag := 1;
        FieldByName('CODIGOESTADO').AsInteger := 2;
        Post;
      end;
      mDL_TB_OrdenesEncabezado.Modificar('Id=' + IntToStr(_Orden), _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_OrdenesEncabezado.Destroy;

      mDL_TB_OrdenesDetalle := TDL_TB_OrdenesDetalle.Create;
      mWhere := TStringList.Create;
      mWhere.Add('IDENCABEZADO = ' + IntToStr(_Orden));
      mDL_TB_OrdenesDetalle.Eliminar(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_OrdenesDetalle.Destroy;

      if Global.USARCONTABILIDAD = 1 then
      begin
        mbs_DBGeneral := tbs_DBGeneral.Create;
        mIdAsiento :=
          mbs_DBGeneral.Obtener_Ultimo('TB_AsientosEncabezado', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mbs_DBGeneral.Destroy;
        Inc(mIdAsiento);

        mDL_TB_AsientosEncabezado := TDL_TB_AsientosEncabezado.Create;
        with mDL_TB_AsientosEncabezado.Dataset do
        begin
          EmptyDataSet;
          mDL_TB_AsientosEncabezado.Limpiar_Tag;
          Append;
          FieldByName('FECHACREACION').Tag := 1;
          FieldByName('FECHACREACION').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('FECHA').Tag := 1;
          FieldByName('FECHA').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('NUMERO').Tag := 1;
          FieldByName('NUMERO').AsString :=
            IntToStr(mIdAsiento);
          FieldByName('CODIGOESTADO').Tag := 1;
          FieldByName('CODIGOESTADO').AsInteger := 2;
          FieldByName('CODIGOCIERRE').Tag := 1;
          FieldByName('CODIGOCIERRE').AsInteger := 0;
          Post;
        end;
        mDL_TB_AsientosEncabezado.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosEncabezado.Destroy;

        mDL_TB_AsientosDetalle := TDL_TB_AsientosDetalle.Create;
        mDL_TB_AsientosDetalle.Dataset.EmptyDataSet;
        mDL_TB_AsientosDetalle.Limpiar_Tag;
        Insertar_AsientoDetalle(mDL_TB_AsientosDetalle, mIdAsiento,
          FormPagar01._IDFormaPago);
        mDL_TB_AsientosDetalle.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosDetalle.Destroy;
      end;

      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mDL_TB_EMPRESAS.Consultar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      // Encabezado Factura Electronica
                {
      dmObjects.DB_Hacienda_TotalesDocumentos(
        dmConnection.FDMainConnection, _DL_TB_FACTURASDETALLEActual.Dataset, dmObjects.FDQuery1,
        mServiciosExentos, mServiciosGravados, mMercanciasExentos, mMercanciasGravados,
        mTotalGravado, mTotalExcento, mTotalVenta, mTotalVentaNeta,
        mTotalDescuentos, mTotalImpuesto, mTotalComprobante,
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_empresasHacienda := TDL_tb_empresas2.Create;
      dmObjects.DB_HaciendaEmpresas_Consultar(dmConnection.FDHaciendaConnection,
        mtb_empresasHacienda.Dataset, '', 0,
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mFecha := Date;
      mConsecutivo := Hacienda_GetConsecutivo(Global.Sucursal, Global.Terminal, '01', 1);
      mClave := Hacienda_GetClave(mFecha, mConsecutivo, '1', mtb_empresasHacienda.Dataset.FieldByName('Identificacion').AsString, '99999999');
      mFechaEmision :=
        FormatDateTime('yyyy-MM-dd', Now) + 'T' +
        FormatDateTime('HH:mm:ss', Now);

      mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
      mDL_TB_CLIENTES.Consultar(_Resultado, _ErrorM,
        'Id=' + IntToStr(GetCombo(cbCliente)), '', '', '', '');

      if Hacienda_TieneInternet = True then
        mIdSituacion := 1
      else
        mIdSituacion := 2;

      mtb_docunentosencabezado := TDL_tb_docunentosencabezado.Create;
      with mtb_docunentosencabezado.Dataset do
      begin
        Append;
        FieldByName('TipoDoc').AsInteger := 1;
        FieldByName('Clave').AsString := mClave;
        FieldByName('NumeroConsecutivo').AsString := mConsecutivo;
        FieldByName('FechaEmision').AsString := mFechaEmision;
        FieldByName('EmisorTipo').AsString := '';
          mtb_empresasHacienda.Dataset.FieldByName('tiposidentificacion').AsString;
        FieldByName('EmisorNumero').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('Identificacion').AsString;
        FieldByName('EmisorNombre').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('Nombre').AsString;
        //FieldByName('EmisorNombreComercial').AsString :=
        FieldByName('EmisorProvincia').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('provincia').AsString;
        FieldByName('EmisorCanton').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('canton').AsString;
        FieldByName('EmisorDistrito').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('distrito').AsString;
        FieldByName('EmisorBarrio').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('barrio').AsString;
        FieldByName('EmisorOtrasSenas').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('Direccion').AsString;
        FieldByName('EmisorCodigoPaisTel').AsInteger := 506;
        try
          Aux01 := StrToInt(mtb_empresasHacienda.Dataset.FieldByName('Telefono').AsString);
        except
          Aux01 := 0;
        end;
        FieldByName('EmisorNumTelefonoTel').AsInteger :=
          Aux01;
        FieldByName('EmisorCodigoPaisFax').AsInteger := 506;
        try
          Aux01 := StrToInt(mtb_empresasHacienda.Dataset.FieldByName('Fax').AsString);
        except
          Aux01 := 0;
        end;
        FieldByName('EmisorNumTelefonoFax').AsInteger :=
          Aux01;
        FieldByName('EmisorCorreoElectronico').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('Email').AsString;
        FieldByName('ReceptorNombre').AsString :=
          mDL_TB_CLIENTES.Dataset.FieldByName('NOMBRECOMPLETO').AsString;
    //    FieldByName('ReceptorTipo').AsString :=
        FieldByName('ReceptorNumero').AsString :=
          mDL_TB_CLIENTES.Dataset.FieldByName('CEDULA').AsString;
    //    FieldByName('ReceptorExtranjero').AsString :=
    //    FieldByName('ReceptorNombreComercial').AsString :=
    //    FieldByName('ReceptorProvincia').AsString :=
    //    FieldByName('ReceptorCanton').AsString :=
    //    FieldByName('ReceptorDistrito').AsString :=
    //    FieldByName('ReceptorBarrio').AsString :=
        FieldByName('ReceptorOtrasSenas').AsString :=
          mDL_TB_CLIENTES.Dataset.FieldByName('DIRECCION').AsString;
        FieldByName('ReceptorCodigoPaisTel').AsInteger := 506;
        try
          Aux01 := StrToInt(mDL_TB_CLIENTES.Dataset.FieldByName('TELEFONO1').AsString);
        except
          Aux01 := 0;
        end;
        FieldByName('ReceptorNumTelefonoTel').AsInteger := Aux01;
        FieldByName('ReceptorCodigoPaisFax').AsInteger := 506;
    //    FieldByName('ReceptorNumTelefonoFax').AsInteger :=
        FieldByName('ReceptorCorreoElectronico').AsString :=
          mDL_TB_CLIENTES.Dataset.FieldByName('EMAIL').AsString;
        FieldByName('CondicionVenta').AsString := mCondicionVenta;
        FieldByName('PlazoCredito').AsString := mPlazoCredito;
        FieldByName('MedioPago').AsString := mMedioPago;
        FieldByName('CodigoMoneda').AsString := 'CRC';
        FieldByName('TipoCambio').AsFloat := 1;
        FieldByName('TotalServGravados').AsFloat :=
          mServiciosGravados;
        FieldByName('TotalServExentos').AsFloat :=
          mServiciosExentos;
        FieldByName('TotalMercanciasGravadas').AsFloat :=
          mMercanciasGravados;
        FieldByName('TotalMercanciasExentas').AsFloat :=
          mMercanciasExentos;
        FieldByName('TotalGravado').AsFloat :=
          mTotalGravado;
        FieldByName('TotalExento').AsFloat :=
          mTotalExcento;
        FieldByName('TotalVenta').AsFloat :=
          mTotalVenta;
        FieldByName('TotalDescuentos').AsFloat :=
          mTotalDescuentos;
        FieldByName('TotalVentaNeta').AsFloat :=
          mTotalVentaNeta;
        FieldByName('TotalImpuesto').AsFloat :=
          mTotalImpuesto;
        FieldByName('TotalComprobante').AsFloat :=
          mTotalComprobante;
        if mIdSituacion > 1 then
        begin
          FieldByName('ReferenciaNumero').AsString := mClave;
          FieldByName('ReferenciaFechaEmision').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('ReferenciaCodigo').AsString := '99';
          FieldByName('ReferenciaRazon').AsString := mClave;
          FieldByName('ReferenciaTipo').AsString := '01';
        end;
        FieldByName('NumeroResolucion').AsString := '';
        FieldByName('FechaResolucion').AsString :=
          FormatDateTime('yyyy-MM-dd', Date);
        FieldByName('OtroTexto').AsString := '';
        FieldByName('OtroContenido').AsString := '';
        FieldByName('Signature').AsString := '';
        FieldByName('IdSucursal').AsInteger :=
          Global.IdSucursal;
        FieldByName('IdTerminal').AsInteger :=
          Global.IdTerminal;
        FieldByName('Numero').AsInteger := mNumero;
        FieldByName('IdEstadoHacienda').AsInteger := 0;
        FieldByName('FechaEmisionD').AsString :=
          FormatDateTime('dd/MM/yyyy', mFecha);
        FieldByName('HoraEmision').AsString :=
          FormatDateTime('HH:mm:ss', Time);
        FieldByName('ReferenciaFechaEmisionD').AsString :=
          FormatDateTime('dd/MM/yyyy', Date);
        FieldByName('ReferenciaHoraEmision').AsString :=
          FormatDateTime('HH:mm:ss', Time);
        FieldByName('XMLSinFirma').AsString := '';
        FieldByName('XMLConFirma').AsString := '';
        FieldByName('Mensaje').AsString := 'Sin Enviar';
        FieldByName('CodigoActividad').AsString := '01';
  //      FieldByName('TotalServExonerado').AsFloat :=
  //      FieldByName('TotalMercExonerada').AsFloat :=
  //      FieldByName('TotalExonerado').AsFloat :=
  //      FieldByName('TotalIVADevuelto').AsFloat :=
  //      FieldByName('TotalOtrosCargos').AsFloat :=
  //      FieldByName('ReceptorOtrasSenasExtranjero').AsString :=
        FieldByName('NumeroCuenta').AsString :=
          mtb_empresasHacienda.Dataset.FieldByName('Cuenta').AsString;
        FieldByName('DocReferencia').AsString :=
          IntToStr(mNumero);
        FieldByName('ReceptorCorreos').AsString :=
          mDL_TB_CLIENTES.Dataset.FieldByName('EMAIL').AsString;
        FieldByName('IdSituacion').AsInteger := mIdSituacion;
        FieldByName('ExtensionAdjuntos').AsString := '';
        FieldByName('IdEmpresa').AsInteger := 0;
        Post;
      end;
      dmObjects.DB_Hacienda_DocumentosEncabezado_Insertar(dmConnection.FDHaciendaConnection,
        mtb_docunentosencabezado.Dataset, 0, 'tb_dcumentosencabezado',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_empresasHacienda.Destroy;
      mDL_TB_CLIENTES.Destroy;

      mIdHacienda :=
        dmObjects.DB_VariosObtener_Ultimo(dmConnection.FDHaciendaConnection,
          'tb_dcumentosencabezado', 'Id', '', 0,
          _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_docunentosdetalle := TDL_tb_docunentosdetalle.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        mNumeroLinea := 1;
        while not Eof do
        begin
          mtb_docunentosdetalle.Dataset.Append;
          mtb_docunentosdetalle.Dataset.FieldByName('IdEncabezado').AsInteger :=
            mIdHacienda;
          mtb_docunentosdetalle.Dataset.FieldByName('NumeroLinea').AsInteger :=
            mNumeroLinea;
          mtb_docunentosdetalle.Dataset.FieldByName('Tipo').AsString := '01';
          mtb_docunentosdetalle.Dataset.FieldByName('Codigo').AsString := '';
          mtb_docunentosdetalle.Dataset.FieldByName('Cantidad').AsFloat :=
            FieldByName('CANTIDAD').AsFloat;
          mtb_docunentosdetalle.Dataset.FieldByName('UnidadMedida').AsString := 'Unid';
          mtb_docunentosdetalle.Dataset.FieldByName('Detalle').AsString :=
            FieldByName('NOMBRE').AsString;
          mtb_docunentosdetalle.Dataset.FieldByName('PrecioUnitario').AsFloat :=
            FieldByName('PRECIOUNITARIO').AsFloat;
          mtb_docunentosdetalle.Dataset.FieldByName('MontoTotal').AsFloat :=
            FieldByName('PRECIOFINALBASE').AsFloat;
          mtb_docunentosdetalle.Dataset.FieldByName('SubTotal').AsFloat :=
            FieldByName('PRECIOFINALBASE').AsFloat;
          mtb_docunentosdetalle.Dataset.FieldByName('PorcentajeCompra').AsFloat := 0;
          mtb_docunentosdetalle.Dataset.FieldByName('MontoTotalLinea').AsFloat :=
            FieldByName('PRECIOFINALBASE').AsFloat;
          mtb_docunentosdetalle.Dataset.FieldByName('ImpuestoNeto').AsFloat := 0;
          mtb_docunentosdetalle.Dataset.FieldByName('IdProducto').AsInteger :=
            FieldByName('IDPRODUCTO').AsInteger;
          mtb_docunentosdetalle.Dataset.Post;
          Inc(mNumeroLinea);
          Next;
        end;
      end;
      dmObjects.DB_Hacienda_DocumentosDetalle_Insertar(dmConnection.FDHaciendaConnection,
        mtb_docunentosdetalle.Dataset, 0, 'tb_dcumentosdetalle',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_documentosdescuentos := TDL_tb_documentosdescuentos.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        mNumeroLinea := 1;
        while not Eof do
        begin
          mtb_documentosdescuentos.Dataset.Append;
          mtb_documentosdescuentos.Dataset.FieldByName('IdEncabezado').AsInteger :=
            mIdHacienda;
          mtb_documentosdescuentos.Dataset.FieldByName('MontoDescuento').AsFloat :=
            FieldByName('DESCUENTOM').AsFloat;
          mtb_documentosdescuentos.Dataset.FieldByName('NaturalezaDescuento').AsString :=
            'Descuento';
          mtb_documentosdescuentos.Dataset.Post;
          Inc(mNumeroLinea);
          Next;
        end;
      end;
      dmObjects.DB_Hacienda__DocumentosDescuentos_Insertar(dmConnection.FDHaciendaConnection,
        mtb_documentosdescuentos.Dataset, 0, 'tb_dcumentosdescuentos',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_docunentosimpuestos := TDL_tb_docunentosimpuestos.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        mNumeroLinea := 1;
        while not Eof do
        begin
          mtb_docunentosimpuestos.Dataset.Append;
          mtb_docunentosimpuestos.Dataset.FieldByName('IdEncabezado').AsInteger :=
            mIdHacienda;
          mtb_docunentosimpuestos.Dataset.FieldByName('NumeroLinea').AsInteger :=
            mNumeroLinea;
          mtb_docunentosimpuestos.Dataset.FieldByName('ImpuestoCodigo').AsString := '01';
          mtb_docunentosimpuestos.Dataset.FieldByName('ImpuestoTarifa').AsFloat := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('ImpuestoMonto').AsFloat :=
            FieldByName('IVAM').AsFloat;
          mtb_docunentosimpuestos.Dataset.FieldByName('CodigoTarifa').AsString := '';
          mtb_docunentosimpuestos.Dataset.FieldByName('FactorIVA').AsFloat := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('PorcentajeExoneracion').AsFloat := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('MontoExoneracion').AsFloat := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('IdProducto').AsInteger := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('IdImpuesto').AsInteger := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('MontoExportacion').AsFloat := 0;
          mtb_docunentosimpuestos.Dataset.FieldByName('Tipodocumento').AsString := '';
          mtb_docunentosimpuestos.Dataset.FieldByName('NumeroDocumento').AsString := '';
          mtb_docunentosimpuestos.Dataset.FieldByName('NombreInstitucion').AsString := '';
          mtb_docunentosimpuestos.Dataset.FieldByName('FechaEmision').AsString :=
            FormatDateTime('yyyy/MM/dd', Date);
          mtb_docunentosimpuestos.Dataset.Post;
          Inc(mNumeroLinea);
          Next;
        end;
      end;
      dmObjects.DB_Hacienda_DocumentosImpuestos_Insertar(dmConnection.FDHaciendaConnection,
        mtb_docunentosimpuestos.Dataset, 0, 'tb_dcumentosimpuestos',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mtb_documentosotroscargos := TDL_tb_documentosotroscargos.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        mNumeroLinea := 1;
        while not Eof do
        begin
          mtb_documentosotroscargos.Dataset.Append;
          mtb_documentosotroscargos.Dataset.FieldByName('IdEncabezado').AsInteger :=
            mIdHacienda;
          mtb_documentosotroscargos.Dataset.FieldByName('TipoDocumento').AsInteger := 6;
          mtb_documentosotroscargos.Dataset.FieldByName('NumeroIdentidadTercero').AsString := '';
          mtb_documentosotroscargos.Dataset.FieldByName('NombreTercero').AsString := '';
          mtb_documentosotroscargos.Dataset.FieldByName('Detalle').AsString := 'Impuesto Servicio';
          mtb_documentosotroscargos.Dataset.FieldByName('Porcentaje').AsFloat := 10;
          mtb_documentosotroscargos.Dataset.FieldByName('MontoCargo').AsFloat :=
            FieldByName('ISM').AsFloat;
          mtb_documentosotroscargos.Dataset.Post;
          Inc(mNumeroLinea);
          Next;
        end;
      end;
      dmObjects.DB_Hacienda_DocumentosOtrosCargos_Insertar(dmConnection.FDHaciendaConnection,
        mtb_documentosotroscargos.Dataset, 0, 'tb_dcumentosotroscargos',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mXMLSinFirma :=
        Get_XML(mtb_docunentosencabezado.Dataset, mtb_docunentosdetalle.Dataset,
          mtb_documentosdescuentos.Dataset, mtb_docunentosimpuestos.Dataset,
          mtb_documentosotroscargos.Dataset, Global.PathTemp, 'FE' + mClave);

      dmObjects.DB_Hacienda_ActualizaXMLSinFirma(dmConnection.FDHaciendaConnection,
        mXMLSinFirma, 'Id = ' + IntToStr(mIdHacienda), 0, 'tb_dcumentosencabezado',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      // Firma
      Hacienda_Firmar(Global.PathAplicacion + '\Config_HaciendaLib.xml',
        Global.PathTemp + '\FE' + mClave + '.xml',
        'FE' + mClave,
        Global.PathAplicacion + '\Hacienda.exe',
        _Resultado, _ErrorM);

      dmObjects.DB_Hacienda_ActualizaXMLConFirma(dmConnection.FDHaciendaConnection,
        mXMLSinFirma, 'Id = ' + IntToStr(mIdHacienda), 0, 'tb_dcumentosencabezado',
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      // Enviar a Hacienda
      Hacienda_Enviar(Global.PathAplicacion + '\Config_HaciendaLib.xml',
        mClave, Global.PathTemp + '\FE' + mClave + '_Firmado.xml',
        Global.PathAplicacion + '\Hacienda.exe', mRespuestaHacienda,
        _Resultado, _ErrorM);

      mtb_docunentosencabezado.Destroy;
      mtb_docunentosdetalle.Destroy;
      mtb_documentosdescuentos.Destroy;
      mtb_docunentosimpuestos.Destroy;
      mtb_documentosotroscargos.Destroy;


      dmObjects.FDQuery1.SQL.Clear;
      dmObjects.FDQuery2.SQL.Clear;
      dmObjects.FDQuery3.SQL.Clear;
      dmObjects.FDQuery4.SQL.Clear;
      dmObjects.FDQuery5.SQL.Clear;

      dmObjects.FDQuery1.SQL.Text :=
        'SELECT * FROM tb_empresas WHERE Id = 0';
      dmObjects.FDQuery2.SQL.Text :=
   'SELECT ' +
    'A.Id,' +
    'A.TipoDoc,' +
    'A.Clave,' +
    'A.NumeroConsecutivo,' +
    'A.FechaEmision,' +
    'A.EmisorTipo,' +
    'A.EmisorNumero, ' +
    'A.EmisorNombre,' +
    'A.EmisorNombreComercial,' +
    'A.EmisorProvincia,' +
    'A.EmisorCanton,' +
    'A.EmisorDistrito, ' +
    'A.EmisorBarrio,' +
    'A.EmisorOtrasSenas,' +
    'A.EmisorCodigoPaisTel,' +
    'A.EmisorNumTelefonoTel,' +
    'A.EmisorCodigoPaisFax,' +
    'A.EmisorNumTelefonoFax,' +
    'A.EmisorCorreoElectronico,' +
    'A.ReceptorNombre,' +
    'A.ReceptorTipo, ' +
    'A.ReceptorNumero,' +
    'A.ReceptorExtranjero,' +
    'A.ReceptorNombreComercial,' +
    'A.ReceptorProvincia,' +
    'A.ReceptorCanton,' +
    'A.ReceptorDistrito,' +
    'A.ReceptorBarrio,' +
    'A.ReceptorOtrasSenas,' +
    'A.ReceptorCodigoPaisTel,' +
    'A.ReceptorNumTelefonoTel, ' +
    'A.ReceptorCodigoPaisFax,' +
    'A.ReceptorNumTelefonoFax,' +
    'A.ReceptorCorreoElectronico, ' +
    'A.CondicionVenta,' +
    'A.PlazoCredito,' +
    'A.MedioPago,' +
    'A.CodigoMoneda,' +
    'A.TipoCambio,' +
    'A.TotalServGravados,' +
    'A.TotalServExentos,' +
    'A.TotalMercanciasGravadas,' +
    'A.TotalMercanciasExentas, ' +
    'A.TotalGravado,' +
    'A.TotalExento,' +
    'A.TotalVenta,' +
    'A.TotalDescuentos,' +
    'A.TotalVentaNeta,' +
    'A.TotalImpuesto,' +
    'A.TotalComprobante,' +
    'A.ReferenciaNumero,' +
    'A.ReferenciaFechaEmision,' +
    'A.ReferenciaCodigo,' +
    'A.ReferenciaRazon,' +
    'A.NumeroResolucion,' +
    'A.FechaResolucion,' +
    'A.OtroTexto,' +
    'A.OtroContenido,' +
    'A.Signature,' +
    'A.IdSucursal,' +
    'A.IdTerminal,' +
    'A.Numero,' +
    'A.IdEstadoHacienda,' +
    'A.FechaEmisionD,' +
    'A.HoraEmision,' +
    'A.ReferenciaFechaEmisionD,' +
    'A.ReferenciaHoraEmision,' +
    'A.XMLSinFirma,' +
    'A.XMLConFirma,' +
    'A.Mensaje,' +
    'A.CodigoActividad,' +
    'A.TotalServExonerado,' +
    'A.TotalMercExonerada, ' +
    'A.TotalExonerado,' +
    'A.TotalIVADevuelto, ' +
    'A.TotalOtrosCargos,' +
    'A.ReceptorOtrasSenasExtranjero,' +
    'A.NumeroCuenta,' +
    'A.DocReferencia,' +
    'A.ReceptorCorreos,' +
    'A.IdSituacion,' +
    'A.IdPlantilla,' +
    'A.Adjuntos,' +
    'A.ExtensionAdjuntos,' +
    'A.ReferenciaTipo,' +
    'A.IdEmpresa,' +
    'B.Nombre AS MedioPagoNombre,' +
    'C.Nombre AS CondicionVentaNombre,' +
    'D.Nombre AS CodigoMonedaNombre,' +
    'D.ABREVIATURA AS CodigoMonedaAbreviatura ' +
    'FROM tb_dcumentosencabezado A ' +
    'LEFT JOIN tb_metodospago B ON A.MedioPago = B.Codigo ' +
    'LEFT JOIN tb_condicionespago C ON A.CondicionVenta = C.Codigo ' +
    'LEFT JOIN tb_monedas D ON A.CodigoMoneda = D.ABREVIATURA ' +
    'WHERE A.Id = 1';
      dmObjects.FDQuery3.SQL.Text :=
        'SELECT * FROM tb_dcumentosdetalle WHERE Id = 0';
      dmObjects.FDQuery4.SQL.Text :=
        'SELECT * FROM tb_dcumentosimpuestos WHERE Id = 0';
      dmObjects.FDQuery5.SQL.Text :=
        'SELECT * FROM tb_dcumentosotroscargos WHERE Id = 0';

      dmObjects.FDQuery1.Connection :=
        dmConnection.FDHaciendaConnection;
      dmObjects.FDQuery2.Connection :=
        dmConnection.FDHaciendaConnection;
      dmObjects.FDQuery3.Connection :=
        dmConnection.FDHaciendaConnection;
      dmObjects.FDQuery4.Connection :=
        dmConnection.FDHaciendaConnection;
      dmObjects.FDQuery5.Connection :=
        dmConnection.FDHaciendaConnection;
      dmReports.frxDBDataset1.DataSet :=
        dmObjects.FDQuery1;
      dmReports.frxDBDataset2.DataSet :=
        dmObjects.FDQuery2;
      dmReports.frxDBDataset3.DataSet :=
        dmObjects.FDQuery3;
      dmReports.frxDBDataset4.DataSet :=
        dmObjects.FDQuery4;
      dmReports.frxDBDataset5.DataSet :=
        dmObjects.FDQuery5;

      dmReports.frxDBDataset1.Enabled := True;
      dmReports.frxDBDataset2.Enabled := True;
      dmReports.frxDBDataset3.Enabled := True;
      dmReports.frxDBDataset4.Enabled := True;
      dmReports.frxDBDataset5.Enabled := True;
      dmReports.frxReport1.LoadFromFile('C:\Users\Public\Proyects\Plantilla.fr3');
      dmReports.frxPDFExport1.FileName := 'C:\Users\Public\Proyects\FE.pdf';
      dmReports.frxPDFExport1.ShowDialog := False;
     // dmReports.frxReport1.Export(dmReports.frxPDFExport1);
     // Sleep(3000);
     // dmReports.frxReport1.ShowReport();
      dmReports.frxDBDataset1.Enabled := False;
      dmReports.frxDBDataset2.Enabled := False;
      dmReports.frxDBDataset3.Enabled := False;
      dmReports.frxDBDataset4.Enabled := False;
      dmReports.frxDBDataset5.Enabled := False;

      EnviarEmail('fernandosolis5@gmail.com',
        'smtp.gmail.com', 465, 'fernandosolis5@gmail.com');
            }
        {
      mArchivo := TStringList.Create;
      mWhere := TStringList.Create;
      mWhere.Add('Id=' + IntToStr(17));
      DL_TB_PLANTILLAS := TDL_TB_PLANTILLAS.Create;
      mArchivo.Text :=
        DL_TB_PLANTILLAS.Obtener_Plantilla(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      DL_TB_PLANTILLAS.Destroy;

      mNombreArchivo := Global.PathAplicacion + '\Plantilla.fr3';
      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      mArchivo.SaveToFile(mNombreArchivo);
      mArchivo.Free;

      mDL_TB_OrdenesDetalle := TDL_TB_OrdenesDetalle.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          mDL_TB_OrdenesDetalle.Dataset.Append;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('idImpresora').AsInteger :=
            FieldByName('IdComanda').AsInteger;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('ProductoNombre').AsString :=
            FieldByName('NOMBRE').AsString;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('CANTIDAD').AsFloat :=
            FieldByName('CANTIDAD').AsFloat;
          mDL_TB_OrdenesDetalle.Dataset.Post;

          Next;
        end;
      end;

      dmReports.frxDBDataset1.DataSet := mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset;
      dmReports.frxDBDataset2.DataSet := mDL_TB_OrdenesDetalle.Dataset;
      dmReports.frxDBDataset3.DataSet := mDL_TB_EMPRESAS.Dataset;
      dmReports.frxDBDataset1.Enabled := True;
      dmReports.frxDBDataset2.Enabled := True;
      dmReports.frxDBDataset3.Enabled := True;

      try
        dmReports.frxReport1.LoadFromFile(mNombreArchivo);
      except
      end;

      with mDL_TB_OrdenesDetalle.Dataset do
      begin
        First;
        while not Eof do
        begin
          if FieldByName('idImpresora').AsInteger = 1 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora1;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 2 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora2;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 3 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora3;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 4 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora4;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;

          Next;
        end;
      end;

      dmReports.frxDBDataset1.Enabled := False;
      dmReports.frxDBDataset2.Enabled := False;
      dmReports.frxDBDataset3.Enabled := False;
      mDL_TB_EMPRESAS.Destroy;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Destroy;
      mDL_TB_OrdenesDetalle.Destroy;
                         }
      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      pnlEstado1.Caption := 'Número: ' + IntToStr(mNumero);
      if _IdEstado = 2 then
        pnlTitulo2.Caption := 'Pagado';
      if _IdEstado = 4 then
        pnlTitulo2.Caption := 'Pendiente';
      if _IdFormaPago = 1 then
        pnlEstado3.Caption := 'Contado';
      if _IdFormaPago = 5 then
        pnlEstado3.Caption := 'Crédito';

      _Numero := mNumero;

      if Application.MessageBox('Desea Imprimir el documento?',
        'Confirmar', MB_ICONQUESTION + MB_YESNO) = IDYES then
        Imprimir_Data;

      _Resultado := 1;

      _IdEstado := 1;
      _IdFormaPago := 0;
      _IdDocumento := 0;
      _Numero := 0;

      Nuevo;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure Pagar_DataDefault;
var
  mDL_TB_FACTURASCLIENTESENCABEZADO: Clase_Tipo1;
  mDL_TB_CONSECUTIVOS: TDL_TB_CONSECUTIVOS;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mNumero: Integer;
  mNombreCliente, mNombreVendedor: string;
  mFechaVencimiento: TDateTime;
  mDL_TB_OrdenesEncabezado: TDL_TB_OrdenesEncabezado;
  mDL_TB_OrdenesDetalle: TDL_TB_OrdenesDetalle;
  mClienteTipoPago, mClientePlazo: Integer;
  mDL_TB_AsientosEncabezado: TDL_TB_AsientosEncabezado;
  mDL_TB_AsientosDetalle: TDL_TB_AsientosDetalle;
  mIdAsiento: Integer;
  mbs_DBGeneral: tbs_DBGeneral;
  mTotalExcento, mTotalGravado, mKilos: Double;
  DL_TB_PLANTILLAS: TDL_TB_PLANTILLAS;
  mArchivo: TStringList;
  mNombreArchivo: string;
  mDL_TB_EMPRESAS: TDL_TB_EMPRESAS;
  mDL_TB_DOCUMENTOSHACIENDA: TDL_TB_DOCUMENTOSHACIENDA;
  mConsecutivo, mClave, mYearS, mMonthS, mDayS, mIdentificacion: string;
  mYear, mMonth, mDay: Word;
  mColumna: Integer;
  mAux01: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      CamposValidos_Pagar1;
      if _Resultado = 0 then
        raise Exception.Create('');

      FormPagar01._PasaForma := False;
      FormPagar01._TipoPago := 1;
      FormPagar01.pnlCredito.Visible := True;
      FormPagar01._Total := _Total;
      FormPagar01._Plazo := Global.DiasVencimientoDefault;

      if GetCombo(cbCliente) > 0 then
      begin
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mClienteTipoPago :=
          mDL_TB_CLIENTES.Obtener_Valor('Id=' + IntToStr(GetCombo(cbCliente)),
            'TIPOPAGO', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mClientePlazo :=
          mDL_TB_CLIENTES.Obtener_Valor('Id=' + IntToStr(GetCombo(cbCliente)),
            'PLAZO', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');

        mDL_TB_CLIENTES.Destroy;

        if mClienteTipoPago = 2 then
        begin
          FormPagar01._TipoPago := 2;
          FormPagar01._Plazo := mClientePlazo;
        end;
      end;

      FormPagar01.Tag := 1;
      mFechaVencimiento := IncDay(dtpFecha.Date, FormPagar01._Plazo);
      lblFechaVencimiento.Caption := FormatDateTime('dd/MM/yyyy',
        mFechaVencimiento);
      if FormPagar01._IDFormaPago = 5 then
        lblFechaVencimiento.Visible := True
      else
        lblFechaVencimiento.Visible := False;
      if FormPagar01._IDFormaPago = 1 then
        _IdEstado := 2;
      if FormPagar01._IDFormaPago = 5 then
        _IdEstado := 4;
      _IdFormaPago := FormPagar01._IDFormaPago;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      CamposValidos_Pagar2;
      if _Resultado = 0 then
        raise Exception.Create('');

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mNumero :=
        mDL_TB_CONSECUTIVOS.Obtener_Valor('', 'FACTURASCLIENTES',
      _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;
      Inc(mNumero);

      if Trim(cbCliente.Text)  = '[SIN SELECCIONAR]' then
        mNombreCliente := ''
      else
        mNombreCliente := Trim(cbCliente.Text);
      if Trim(cbVendedor.Text)  = '[SIN SELECCIONAR]' then
        mNombreVendedor := ''
      else
        mNombreVendedor := Trim(cbVendedor.Text);

      // Varios
      mTotalExcento := 0;
      mTotalGravado := 0;
      mKilos := 0;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          if FieldByName('IVAM').AsFloat <> 0 then
            mTotalExcento := mTotalExcento +
              FieldByName('PRECIOFINAL').AsFloat
          else
            mTotalGravado := mTotalGravado +
              FieldByName('PRECIOFINAL').AsFloat;
          mKilos := mKilos +
            FieldByName('TOTALKILOS').AsFloat;
          Next;
        end;
      end;

      FormPagar01._IDFormaPago := 1;
      FormPagar01._Pagado := _Total;
      FormPagar01._CreditoTotal := 0;
      FormPagar01._Cambio := 0;
      FormPagar01._EfectivoTotal := _Total;
      FormPagar01._TarjetaTotal := 0;
      FormPagar01._TransferenciaTotal := 0;
      FormPagar01._ChequeTotal := 0;
      _IdEstado := 2;

      // Encabezado
      mDL_TB_FACTURASCLIENTESENCABEZADO := Clase_Tipo1.Create;
      with mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset do
      begin
        EmptyDataSet;
        mDL_TB_FACTURASCLIENTESENCABEZADO.Limpiar_Tag;
        Append;
        FieldByName('NUMERO').Tag := 1;
        FieldByName('NUMERO').AsInteger :=
          mNumero;
        FieldByName('FECHA').Tag := 1;
        FieldByName('FECHA').AsString :=
          FormatDateTime('dd/MM/yyyy', dtpFecha.Date);
        FieldByName('HORA').Tag := 1;
        FieldByName('HORA').AsString :=
          FormatDateTime('HH:mm:ss', Time);
        FieldByName('CODIGOMESA').Tag := 1;
        FieldByName('CODIGOMESA').AsInteger := 0;
        FieldByName('NUMEROMESA').Tag := 1;
        FieldByName('NUMEROMESA').AsString := '';
        FieldByName('NOMBRECLIENTE').Tag := 1;
        FieldByName('NOMBRECLIENTE').AsString :=
          mNombreCliente;
        FieldByName('SUBTOTAL').Tag := 1;
        FieldByName('SUBTOTAL').AsFloat :=
          _SubTotal;
        FieldByName('DESCUENTOP').Tag := 1;
        FieldByName('DESCUENTOP').AsFloat := 0;
        FieldByName('DESCUENTOM').Tag := 1;
        FieldByName('DESCUENTOM').AsFloat :=
          _DescuentoM;
        FieldByName('IVAP').Tag := 1;
        FieldByName('IVAP').AsFloat := 0;
        FieldByName('IVAM').Tag := 1;
        FieldByName('IVAM').AsFloat :=
          _IVAM;
        FieldByName('ISP').Tag := 1;
        FieldByName('ISP').AsFloat := 0;
        FieldByName('ISM').Tag := 1;
        FieldByName('ISM').AsFloat :=
          _ISM;
        FieldByName('TRANSPORTE').Tag := 1;
        FieldByName('TRANSPORTE').AsFloat := 0;
        FieldByName('TOTAL').Tag := 1;
        FieldByName('TOTAL').AsFloat :=
          _Total;
        FieldByName('TOTALGRAVADO').Tag := 1;
        FieldByName('TOTALGRAVADO').AsFloat :=
          mTotalGravado;
        FieldByName('TOTALEXCENTO').Tag := 1;
        FieldByName('TOTALEXCENTO').AsFloat :=
          mTotalExcento;
        FieldByName('CODIGOESTADO').Tag := 1;
        FieldByName('CODIGOESTADO').AsInteger :=
          _IdEstado;
        FieldByName('CODIGOFORMAPAGO').Tag := 1;
        FieldByName('CODIGOFORMAPAGO').AsInteger :=
          FormPagar01._IDFormaPago;
        FieldByName('FECHAVENCIMIENTO').Tag := 1;
        FieldByName('FECHAVENCIMIENTO').AsString :=
          FormatDateTime('dd/MM/yyyy', mFechaVencimiento);
        FieldByName('CODIGOTIPO').Tag := 1;
        FieldByName('CODIGOTIPO').AsInteger := 1;
        FieldByName('SALDO').Tag := 1;
        FieldByName('SALDO').AsFloat :=
          FormPagar01._CreditoTotal;
        FieldByName('NOMBREVENDEDOR').Tag := 1;
        FieldByName('NOMBREVENDEDOR').AsString :=
          mNombreVendedor;
        FieldByName('NUMEROPROFORMA').Tag := 1;
        FieldByName('NUMEROPROFORMA').AsInteger := 0;
        FieldByName('PAGOCON').Tag := 1;
        FieldByName('PAGOCON').AsFloat :=
          FormPagar01._Pagado;
        FieldByName('CAMBIO').Tag := 1;
        FieldByName('CAMBIO').AsFloat :=
          FormPagar01._Cambio;
        FieldByName('EFECTIVO').Tag := 1;
        FieldByName('EFECTIVO').AsFloat :=
          FormPagar01._EfectivoTotal;
        FieldByName('TARJETA').Tag := 1;
        FieldByName('TARJETA').AsFloat :=
          FormPagar01._TarjetaTotal;
        FieldByName('TRANSFERENCIA').Tag := 1;
        FieldByName('TRANSFERENCIA').AsFloat :=
          FormPagar01._TransferenciaTotal;
        FieldByName('CHEQUE').Tag := 1;
        FieldByName('CHEQUE').AsFloat :=
          FormPagar01._ChequeTotal;
        FieldByName('IdCliente').Tag := 1;
        FieldByName('IdCliente').AsInteger :=
          GetCombo(cbCliente);
        FieldByName('IdVendedor').Tag := 1;
        FieldByName('IdVendedor').AsInteger :=
          GetCombo(cbVendedor);
        FieldByName('NUMERONotaCredito').Tag := 1;
        FieldByName('NUMERONotaCredito').AsInteger := 0;
        FieldByName('Kilos').Tag := 1;
        FieldByName('Kilos').AsFloat :=
          mKilos;
        Post;
      end;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mDL_TB_CONSECUTIVOS.Actualizar_Campo('', 'FACTURASCLIENTES', mNumero,
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;

      // Detalle
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          Edit;
          FieldByName('NUMERO').Tag := 1;
          FieldByName('NUMERO').AsInteger :=
            mNumero;
          FieldByName('CODIGOESTADO').Tag := 1;
          FieldByName('CODIGOESTADO').AsInteger := 2;
          Post;
          Next;
        end;
      end;
      _DL_TB_FACTURASDETALLEActual.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      // Actualizar Existencias
      mWhere := TStringList.Create;
      mWhere.Add('Numero=' + IntToStr(mNumero));
      _DL_TB_FACTURASDETALLEActual.Restar_Existencias(mWhere.Text,
        _DL_TB_FACTURASDETALLEActual.DataSet, _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;

      // Actualiza Saldo Cliente
      if FormPagar01._IDFormaPago = 5 then
      begin
        mWhere := TStringList.Create;
        mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mDL_TB_CLIENTES.Sumar_Saldo(mWhere.Text,
          FormPagar01._CreditoTotal, _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_CLIENTES.Destroy;
      end;

      // Hacienda
      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mIdentificacion :=
        mDL_TB_EMPRESAS.Obtener_Valor('', 'CEDULA', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
      mDL_TB_EMPRESAS.Destroy;
      mIdentificacion := Copy(mIdentificacion, 1, 12);
      mAux01 := '';
      for mColumna := 1 to Length(mIdentificacion) do
      begin
        if mIdentificacion[mColumna] = '-' then
          mAux01 := mAux01 + '0'
        else
          mAux01 := mAux01 + mIdentificacion[mColumna];
      end;
      mIdentificacion := mAux01;

      //mConsecutivo := GetConsecutivo(Global.Sucursal, Global.Terminal, '1', mNumero);
      DecodeDate(dtpFecha.Date, mYear, mMonth, mDay);
      try
        mYearS := IntToStr(mYear);
        mYearS := copy(mYearS, 3, 2);
      except
        mYearS := '00';
      end;
      try
        mMonthS := IntToStr(mMonth);
        if Length(mMonthS)  = 1 then
          mMonthS := '0' + mMonthS;
      except
        mMonthS := '01';
      end;
      try
        mDayS := IntToStr(mDay);
        if Length(mDayS)  = 1 then
          mDayS := '0' + mDayS;
      except
        mDayS := '01';
      end;
     // mClave := GetClave(dtpFecha.Date, mConsecutivo, '1', mIdentificacion, '99999999');
      mDL_TB_DOCUMENTOSHACIENDA := TDL_TB_DOCUMENTOSHACIENDA.Create;
      with mDL_TB_DOCUMENTOSHACIENDA.Dataset do
      begin
        mDL_TB_DOCUMENTOSHACIENDA.Limpiar_Tag;
        EmptyDataSet;
        Append;
        FieldByName('IDENCABEZADO').Tag := 1;
        FieldByName('IDENCABEZADO').AsInteger := mNumero;
        FieldByName('SUCURSAL').Tag := 1;
        FieldByName('SUCURSAL').AsString := Global.Sucursal;
        FieldByName('TERMINAL').Tag := 1;
        FieldByName('TERMINAL').AsString := Global.Terminal;
        FieldByName('TIPO').Tag := 1;
        FieldByName('TIPO').AsString := '1';
        FieldByName('NUMERACION').Tag := 1;
        FieldByName('NUMERACION').AsString := IntToStr(mNumero);
        FieldByName('CONSECUTIVO').Tag := 1;
        FieldByName('CONSECUTIVO').AsString := mConsecutivo;
        FieldByName('PAIS').Tag := 1;
        FieldByName('PAIS').AsString := '506';
        FieldByName('DIA').Tag := 1;
        FieldByName('DIA').AsString := mDayS;
        FieldByName('MES').Tag := 1;
        FieldByName('MES').AsString := mMonthS;
        FieldByName('MYEAR').Tag := 1;
        FieldByName('MYEAR').AsString := mYearS;
        FieldByName('IDENTIFICACION').Tag := 1;
        FieldByName('IDENTIFICACION').AsString := mIdentificacion;
        FieldByName('SITUACION').Tag := 1;
        FieldByName('SITUACION').AsString := '1';
        FieldByName('SEGURIDAD').Tag := 1;
        FieldByName('SEGURIDAD').AsString := '99999999';
        FieldByName('CLAVE').Tag := 1;
        FieldByName('CLAVE').AsString := mClave;
        FieldByName('MQR').Tag := 1;
        FieldByName('MQR').AsString := mClave;
        Post;
      end;
      mDL_TB_DOCUMENTOSHACIENDA.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_DOCUMENTOSHACIENDA.Destroy;

      // Ordenes
      mDL_TB_OrdenesEncabezado := TDL_TB_OrdenesEncabezado.Create;
      with mDL_TB_OrdenesEncabezado.Dataset do
      begin
        mDL_TB_OrdenesEncabezado.Limpiar_Tag;
        EmptyDataSet;
        Append;
        FieldByName('ETIQUETA').Tag := 1;
        FieldByName('ETIQUETA').AsString := '';
        FieldByName('VENTA').Tag := 1;
        FieldByName('VENTA').AsFloat := 0;
        FieldByName('COMENTARIOS').Tag := 1;
        FieldByName('COMENTARIOS').AsString := '';
        FieldByName('IDCLIENTE').Tag := 1;
        FieldByName('IDCLIENTE').AsInteger := 0;
        FieldByName('FECHA').Tag := 1;
        FieldByName('FECHA').AsDateTime := Date;
        FieldByName('HORA').Tag := 1;
        FieldByName('HORA').AsString := '';
        FieldByName('CODIGOESTADO').Tag := 1;
        FieldByName('CODIGOESTADO').AsInteger := 2;
        Post;
      end;
      mDL_TB_OrdenesEncabezado.Modificar('Id=' + IntToStr(_Orden), _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_OrdenesEncabezado.Destroy;

      mDL_TB_OrdenesDetalle := TDL_TB_OrdenesDetalle.Create;
      mWhere := TStringList.Create;
      mWhere.Add('IDENCABEZADO = ' + IntToStr(_Orden));
      mDL_TB_OrdenesDetalle.Eliminar(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_OrdenesDetalle.Destroy;

      if Global.USARCONTABILIDAD = 1 then
      begin
        mbs_DBGeneral := tbs_DBGeneral.Create;
        mIdAsiento :=
          mbs_DBGeneral.Obtener_Ultimo('TB_AsientosEncabezado', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mbs_DBGeneral.Destroy;
        Inc(mIdAsiento);

        mDL_TB_AsientosEncabezado := TDL_TB_AsientosEncabezado.Create;
        with mDL_TB_AsientosEncabezado.Dataset do
        begin
          EmptyDataSet;
          mDL_TB_AsientosEncabezado.Limpiar_Tag;
          Append;
          FieldByName('FECHACREACION').Tag := 1;
          FieldByName('FECHACREACION').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('FECHA').Tag := 1;
          FieldByName('FECHA').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('NUMERO').Tag := 1;
          FieldByName('NUMERO').AsString :=
            IntToStr(mIdAsiento);
          FieldByName('CODIGOESTADO').Tag := 1;
          FieldByName('CODIGOESTADO').AsInteger := 2;
          FieldByName('CODIGOCIERRE').Tag := 1;
          FieldByName('CODIGOCIERRE').AsInteger := 0;
          Post;
        end;
        mDL_TB_AsientosEncabezado.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosEncabezado.Destroy;

        mDL_TB_AsientosDetalle := TDL_TB_AsientosDetalle.Create;
        mDL_TB_AsientosDetalle.Dataset.EmptyDataSet;
        mDL_TB_AsientosDetalle.Limpiar_Tag;
        Insertar_AsientoDetalle(mDL_TB_AsientosDetalle, mIdAsiento,
          FormPagar01._IDFormaPago);
        mDL_TB_AsientosDetalle.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosDetalle.Destroy;
      end;

      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mDL_TB_EMPRESAS.Consultar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      mArchivo := TStringList.Create;
      mWhere := TStringList.Create;
      mWhere.Add('Id=' + IntToStr(17));
      DL_TB_PLANTILLAS := TDL_TB_PLANTILLAS.Create;
      mArchivo.Text :=
        DL_TB_PLANTILLAS.Obtener_Plantilla(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      DL_TB_PLANTILLAS.Destroy;

      mNombreArchivo := Global.PathAplicacion + '\Plantilla.fr3';
      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      mArchivo.SaveToFile(mNombreArchivo);
      mArchivo.Free;

      mDL_TB_OrdenesDetalle := TDL_TB_OrdenesDetalle.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          mDL_TB_OrdenesDetalle.Dataset.Append;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('idImpresora').AsInteger :=
            FieldByName('IdComanda').AsInteger;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('ProductoNombre').AsString :=
            FieldByName('NOMBRE').AsString;
          mDL_TB_OrdenesDetalle.Dataset.FieldByName('CANTIDAD').AsFloat :=
            FieldByName('CANTIDAD').AsFloat;
          mDL_TB_OrdenesDetalle.Dataset.Post;

          Next;
        end;
      end;

      dmReports.frxDBDataset1.DataSet := mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset;
      dmReports.frxDBDataset2.DataSet := mDL_TB_OrdenesDetalle.Dataset;
      dmReports.frxDBDataset3.DataSet := mDL_TB_EMPRESAS.Dataset;
      dmReports.frxDBDataset1.Enabled := True;
      dmReports.frxDBDataset2.Enabled := True;
      dmReports.frxDBDataset3.Enabled := True;

      try
        dmReports.frxReport1.LoadFromFile(mNombreArchivo);
      except
      end;

      with mDL_TB_OrdenesDetalle.Dataset do
      begin
        First;
        while not Eof do
        begin
          if FieldByName('idImpresora').AsInteger = 1 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora1;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 2 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora2;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 3 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora3;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;
          if FieldByName('idImpresora').AsInteger = 4 then
          begin
            dmReports.frxReport1.PrepareReport();
            dmReports.frxReport1.PrintOptions.Printer :=
              Global.OrdenesImpresora4;
            dmReports.frxReport1.PrintOptions.ShowDialog := False;
            dmReports.frxReport1.Print;
          end;

          Next;
        end;
      end;

      dmReports.frxDBDataset1.Enabled := False;
      dmReports.frxDBDataset2.Enabled := False;
      dmReports.frxDBDataset3.Enabled := False;
      mDL_TB_EMPRESAS.Destroy;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Destroy;
      mDL_TB_OrdenesDetalle.Destroy;

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      pnlEstado1.Caption := 'Número: ' + IntToStr(mNumero);
      if _IdEstado = 2 then
        pnlTitulo2.Caption := 'Pagado';
      if _IdEstado = 4 then
        pnlTitulo2.Caption := 'Pendiente';
      if _IdFormaPago = 1 then
        pnlEstado3.Caption := 'Contado';
      if _IdFormaPago = 5 then
        pnlEstado3.Caption := 'Crédito';

      _Numero := mNumero;

      Imprimir_Data;

      _Resultado := 1;

      _IdEstado := 1;
      _IdFormaPago := 0;
      _IdDocumento := 0;
      _Numero := 0;

      Nuevo;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure Anular_Data;
var
  mDL_TB_FACTURASCLIENTESENCABEZADO: Clase_Tipo1;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mDL_TB_NOTASCREDITOENCABEZADO: TDL_TB_NOTASCREDITOENCABEZADO;
  mDL_TB_NOTASCREDITODETALLE: TDL_TB_NOTASCREDITODETALLE;
  mDL_TB_CONSECUTIVOS: TDL_TB_CONSECUTIVOS;
  mWhere: TStringList;
  mResultado, mNumero: Integer;
  mErrorM: string;
  mNombreCliente: string;
  mDL_TB_AsientosEncabezado: TDL_TB_AsientosEncabezado;
  mDL_TB_AsientosDetalle: TDL_TB_AsientosDetalle;
  mIdAsiento, mNumeroNotaCredito: Integer;
  mbs_DBGeneral: tbs_DBGeneral;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      FormNotasCredito01._Origen := 2;
      FormNotasCredito01._Factura := _Numero;
      FormNotasCredito01._IdEstado := 1;
      FormNotasCredito01.ShowModal;
     {
      // Encabezado
      mWhere := TStringList.Create;
      mWhere.Add('Numero=' + IntToStr(_Numero));
      mDL_TB_FACTURASCLIENTESENCABEZADO := Clase_Tipo1.Create;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Actualizar_Estado(mWhere.Text, 3,
        _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_FACTURASCLIENTESENCABEZADO.Destroy;

      // Actualizar Existencias
      mWhere := TStringList.Create;
      mWhere.Add('Numero=' + IntToStr(_Numero));
      _DL_TB_FACTURASDETALLEActual.Sumar_Existencias(mWhere.Text,
        _DL_TB_FACTURASDETALLEActual.DataSet, _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      _DL_TB_FACTURASDETALLEActual.Actualizar_Campo(mWhere.Text,
        'CODIGOESTADO', 3, _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;

      // Actualiza Saldo Cliente
      if _IDFormaPago = 5 then
      begin
        mWhere := TStringList.Create;
        mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
        mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
        mDL_TB_CLIENTES.Restar_Saldo(mWhere.Text, _Total,
          _Resultado, _ErrorM);
        mWhere.Free;
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_CLIENTES.Destroy;
      end;

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mNumeroNotaCredito :=
        mDL_TB_CONSECUTIVOS.Obtener_Valor('', 'NOTASCREDITO',
      _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;
      Inc(mNumeroNotaCredito);

      if Trim(cbCliente.Text)  = '[SIN SELECCIONAR]' then
        mNombreCliente := ''
      else
        mNombreCliente := Trim(cbCliente.Text);

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mNumero :=
        mDL_TB_CONSECUTIVOS.Obtener_Valor('', 'FACTURASCLIENTES',
      _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;
      Inc(mNumero);

      mDL_TB_NOTASCREDITOENCABEZADO := TDL_TB_NOTASCREDITOENCABEZADO.Create;
      with mDL_TB_NOTASCREDITOENCABEZADO.Dataset do
      begin
        EmptyDataSet;
        mDL_TB_NOTASCREDITOENCABEZADO.Limpiar_Tag;
        Append;
        FieldByName('Numero').Tag := 1;
        FieldByName('Numero').AsInteger :=
          mNumeroNotaCredito;
        FieldByName('FECHA').Tag := 1;
        FieldByName('FECHA').AsString :=
          FormatDateTime('dd/MM/yyyy', dtpFecha.Date);
        FieldByName('HORA').Tag := 1;
        FieldByName('HORA').AsString :=
          FormatDateTime('HH:mm:ss', Time);
        FieldByName('NOMBRECLIENTE').Tag := 1;
        FieldByName('NOMBRECLIENTE').AsString :=
          mNombreCliente;
        FieldByName('IdCliente').Tag := 1;
        FieldByName('IdCliente').AsInteger :=
          GetCombo(cbCliente);
        FieldByName('NumeroDocumento').Tag := 1;
        FieldByName('NumeroDocumento').AsInteger :=
          _Numero;
        FieldByName('Total').Tag :=  1;
        FieldByName('Total').AsFloat :=
          _Total;
        FieldByName('Comentarios').Tag := 1;
        FieldByName('Comentarios').AsString :=
          'Anulado';
        FieldByName('CODIGOESTADO').Tag := 1;
        FieldByName('CODIGOESTADO').AsInteger := 2;
        FieldByName('CODIGOFORMAPAGO').Tag := 1;
        FieldByName('CODIGOFORMAPAGO').AsInteger := 1;
        FieldByName('EFECTIVO').Tag :=  1;
        FieldByName('EFECTIVO').AsFloat :=
          _Total;
        FieldByName('IdVendedor').Tag := 1;
        FieldByName('IdVendedor').AsInteger :=
          GetCombo(cbVendedor);
        Post;
      end;
      mDL_TB_NOTASCREDITOENCABEZADO.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_NOTASCREDITOENCABEZADO.Destroy;

      mDL_TB_NOTASCREDITODETALLE := TDL_TB_NOTASCREDITODETALLE.Create;
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          mDL_TB_NOTASCREDITODETALLE.Dataset.Append;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('NUMERO').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('NUMERO').AsInteger :=
            mNumeroNotaCredito;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CODIGO').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CODIGO').AsString :=
            FieldByName('CODIGO').AsString;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('NOMBRE').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('NOMBRE').AsString :=
            FieldByName('NOMBRE').AsString;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CANTIDAD').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CANTIDAD').AsFloat :=
            FieldByName('CANTIDAD').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOUNITARIO').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOUNITARIO').AsFloat :=
            FieldByName('PRECIOUNITARIO').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('DESCUENTOP').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('DESCUENTOP').AsFloat :=
            FieldByName('DESCUENTOP').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('DESCUENTOM').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('DESCUENTOM').AsFloat :=
            FieldByName('DESCUENTOM').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IVAP').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IVAP').AsFloat :=
            FieldByName('IVAP').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IVAM').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IVAM').AsFloat :=
            FieldByName('IVAM').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
            FieldByName('PRECIOUNITARIOFINAL').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOFINAL').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('PRECIOFINAL').AsFloat :=
            FieldByName('PRECIOFINAL').AsFloat;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('LINEA').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('LINEA').AsInteger :=
            FieldByName('LINEA').AsInteger;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IdProducto').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('IdProducto').AsInteger :=
            FieldByName('IdProducto').AsInteger;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CODIGOESTADO').Tag := 1;
          mDL_TB_NOTASCREDITODETALLE.Dataset.FieldByName('CODIGOESTADO').AsInteger := 3;
          mDL_TB_NOTASCREDITODETALLE.Dataset.Post;

          Next;
        end;
      end;
      mDL_TB_NOTASCREDITODETALLE.Insertar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_NOTASCREDITODETALLE.Destroy;

      mDL_TB_CONSECUTIVOS := TDL_TB_CONSECUTIVOS.Create;
      mDL_TB_CONSECUTIVOS.Actualizar_Campo('', 'NOTASCREDITO', mNumeroNotaCredito,
        _Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');
      mDL_TB_CONSECUTIVOS.Destroy;

      if Global.USARCONTABILIDAD = 1 then
      begin
        mbs_DBGeneral := tbs_DBGeneral.Create;
        mIdAsiento :=
          mbs_DBGeneral.Obtener_Ultimo('TB_AsientosEncabezado', _Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mbs_DBGeneral.Destroy;
        Inc(mIdAsiento);

        mDL_TB_AsientosEncabezado := TDL_TB_AsientosEncabezado.Create;
        with mDL_TB_AsientosEncabezado.Dataset do
        begin
          EmptyDataSet;
          mDL_TB_AsientosEncabezado.Limpiar_Tag;
          Append;
          FieldByName('FECHACREACION').Tag := 1;
          FieldByName('FECHACREACION').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('FECHA').Tag := 1;
          FieldByName('FECHA').AsString :=
            FormatDateTime('dd/MM/yyyy', Date);
          FieldByName('NUMERO').Tag := 1;
          FieldByName('NUMERO').AsString :=
            IntToStr(mIdAsiento);
          FieldByName('CODIGOESTADO').Tag := 1;
          FieldByName('CODIGOESTADO').AsInteger := 2;
          FieldByName('CODIGOCIERRE').Tag := 1;
          FieldByName('CODIGOCIERRE').AsInteger := 0;
          Post;
        end;
        mDL_TB_AsientosEncabezado.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosEncabezado.Destroy;

        mDL_TB_AsientosDetalle := TDL_TB_AsientosDetalle.Create;
        mDL_TB_AsientosDetalle.Dataset.EmptyDataSet;
        mDL_TB_AsientosDetalle.Limpiar_Tag;
        Insertar_AsientoDetalle_Anulado(mDL_TB_AsientosDetalle, mIdAsiento,
          FormPagar01._IDFormaPago);
        mDL_TB_AsientosDetalle.Insertar(_Resultado, _ErrorM);
        if _Resultado = -1 then
          raise Exception.Create('');
        mDL_TB_AsientosDetalle.Destroy;
      end;
                    }
      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _IdEstado := 3;

      if _IdEstado = 3 then
        pnlTitulo2.Caption := 'Anulado';

      btnPagar.Enabled := False;
      btnAnular.Enabled := False;
      btnImprimir.Enabled := True;
      pnlEstado.Enabled := False;
      pnlEncabezado.Enabled := False;
      pnlDetalle.Enabled := False;
      pnlListaTitulo.Enabled := True;
      imgAnulado.Visible := True;

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure Imprimir_Data;
var
  DL_TB_PLANTILLAS: TDL_TB_PLANTILLAS;
  mDL_TB_FACTURASCLIENTESENCABEZADO: Clase_Tipo1;
  mDL_TB_FACTURASDETALLE: Clase_Tipo2;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mDL_TB_Hacienda: TDL_TB_DOCUMENTOSHACIENDA;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mArchivo: TStringList;
  mNombreArchivo: string;
  mDL_TB_EMPRESAS: TDL_TB_EMPRESAS;
  mBS_facturasclientesencabezado: TFDMemTable;
  mBS_facturasclientesdetalle: TFDMemTable;
  mBS_Hacienda: TFDMemTable;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      mBS_Hacienda := TFDMemTable.Create(nil);
      with mBS_Hacienda do
      begin
        FieldDefs.Clear;
        FieldDefs.Add('ID', ftInteger, 0);
        FieldDefs.Add('IDENCABEZADO', ftInteger, 0);
        FieldDefs.Add('SUCURSAL', ftString, 3);
        FieldDefs.Add('TERMINAL', ftString, 5);
        FieldDefs.Add('TIPO', ftString, 2);
        FieldDefs.Add('NUMERACION', ftString, 10);
        FieldDefs.Add('CONSECUTIVO', ftString, 20);
        FieldDefs.Add('PAIS', ftString, 3);
        FieldDefs.Add('DIA', ftString, 3);
        FieldDefs.Add('MES', ftString, 3);
        FieldDefs.Add('MYEAR', ftString, 3);
        FieldDefs.Add('IDENTIFICACION', ftString, 11);
        FieldDefs.Add('SITUACION', ftString, 1);
        FieldDefs.Add('SEGURIDAD', ftString, 8);
        FieldDefs.Add('CLAVE', ftString, 50);
        FieldDefs.Add('MQR', ftMemo, 0);
        CreateDataSet;
        Open;
      end;

      mBS_facturasclientesencabezado := TFDMemTable.Create(nil);
      with mBS_facturasclientesencabezado do
      begin
        FieldDefs.Clear;
        FieldDefs.Add('Factura_Numero', ftInteger, 0);
        FieldDefs.Add('Fecha', ftDateTime, 0);
        FieldDefs.Add('Hora', ftString, 30);
        FieldDefs.Add('CodigoCliente', ftString, 300);
        FieldDefs.Add('NombreCliente', ftString, 300);
        FieldDefs.Add('SubTotal', ftFloat, 0);
        FieldDefs.Add('DescuentoPorcentaje', ftFloat, 0);
        FieldDefs.Add('DescuentoMonto', ftFloat, 0);
        FieldDefs.Add('IVAPorcentaje', ftFloat, 0);
        FieldDefs.Add('IVAMonto', ftFloat, 0);
        FieldDefs.Add('Transporte', ftFloat, 0);
        FieldDefs.Add('Total', ftFloat, 0);
        FieldDefs.Add('TotalGravado', ftFloat, 0);
        FieldDefs.Add('TotalExcento', ftFloat, 0);
        FieldDefs.Add('Estado', ftString, 300);
        FieldDefs.Add('FormaPago', ftString, 300);
        FieldDefs.Add('Moneda', ftString, 300);
        FieldDefs.Add('TipoCambio', ftFloat, 0);
        FieldDefs.Add('Serie', ftString, 300);
        FieldDefs.Add('Impresa', ftString, 300);
        FieldDefs.Add('NumeroDoc', ftString, 300);
        FieldDefs.Add('FechaVencimiento', ftDateTime, 0);
        FieldDefs.Add('Tipo', ftInteger, 0);
        FieldDefs.Add('Saldo', ftFloat, 0);
        FieldDefs.Add('CarCredito', ftString, 300);
        FieldDefs.Add('CarContado', ftString, 300);
        FieldDefs.Add('CodigoVendedor', ftString, 300);
        FieldDefs.Add('NombreVendedor', ftString, 300);
        FieldDefs.Add('Numero_Proforma', ftInteger, 0);
        FieldDefs.Add('PagoCon', ftFloat, 0);
        FieldDefs.Add('Cambio', ftFloat, 0);
        FieldDefs.Add('FraseMayorista', ftString, 300);
        FieldDefs.Add('DireccionCliente', ftString, 300);
        FieldDefs.Add('Telefono1Cliente', ftString, 300);
        FieldDefs.Add('ServicioMonto', ftFloat, 0);
        FieldDefs.Add('ContactoNombre', ftString, 300);
        CreateDataSet;
        Open;
      end;

      mBS_facturasclientesdetalle := TFDMemTable.Create(nil);
      with mBS_facturasclientesdetalle do
      begin
        FieldDefs.Clear;
        FieldDefs.Add('Codigo_Producto', ftString, 300);
        FieldDefs.Add('Nombre_Producto', ftString, 300);
        FieldDefs.Add('Cantidad', ftFloat, 0);
        FieldDefs.Add('UnidadMedida', ftString, 300);
        FieldDefs.Add('PrecioUnitario', ftFloat, 0);
        FieldDefs.Add('PrecioUnitarioFinal', ftFloat, 0);
        FieldDefs.Add('DescuentoPorcentaje', ftFloat, 0);
        FieldDefs.Add('DescuentoMonto', ftFloat, 0);
        FieldDefs.Add('PrecioFinal', ftFloat, 0);
        FieldDefs.Add('Impuesto', ftFloat, 0);
        FieldDefs.Add('PrecioMayoristaAplicado', ftString, 300);
        FieldDefs.Add('Descripcion_Producto', ftString, 300);
        FieldDefs.Add('CodigoBarras', ftString, 300);
        FieldDefs.Add('PrecioUnitarioBase', ftFloat, 0);
        FieldDefs.Add('PrecioFinalBase', ftFloat, 0);
        FieldDefs.Add('Descripcion1', ftString, 300);
        FieldDefs.Add('Descripcion2', ftString, 300);
        CreateDataSet;
        Open;
      end;

      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mDL_TB_EMPRESAS.Consultar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mWhere := TStringList.Create;
      mWhere.Add('IDENCABEZADO=' + IntToStr(_Numero));
      mWhere.Add(' And ');
      mWhere.Add(' TIPO = ' + QuotedStr('1'));
      mDL_TB_Hacienda := TDL_TB_DOCUMENTOSHACIENDA.Create;
      mDL_TB_Hacienda.Consultar(_Resultado, _ErrorM, mWhere.Text);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      with mDL_TB_Hacienda.Dataset do
      begin
        First;
        while not Eof do
        begin
          mBS_Hacienda.Append;
          mBS_Hacienda.FieldByName('ID').AsInteger :=
            FieldByName('ID').AsInteger;
          mBS_Hacienda.FieldByName('IDENCABEZADO').AsInteger :=
            FieldByName('IDENCABEZADO').AsInteger;
          mBS_Hacienda.FieldByName('SUCURSAL').AsString :=
            FieldByName('SUCURSAL').AsString;
          mBS_Hacienda.FieldByName('TERMINAL').AsString :=
            FieldByName('TERMINAL').AsString;
          mBS_Hacienda.FieldByName('TIPO').AsString :=
            FieldByName('TIPO').AsString;
          mBS_Hacienda.FieldByName('NUMERACION').AsString :=
            FieldByName('NUMERACION').AsString;
          mBS_Hacienda.FieldByName('CONSECUTIVO').AsString :=
            FieldByName('CONSECUTIVO').AsString;
          mBS_Hacienda.FieldByName('PAIS').AsString :=
            FieldByName('PAIS').AsString;
          mBS_Hacienda.FieldByName('DIA').AsString :=
            FieldByName('DIA').AsString;
          mBS_Hacienda.FieldByName('MES').AsString :=
            FieldByName('MES').AsString;
          mBS_Hacienda.FieldByName('MYEAR').AsString :=
            FieldByName('MYEAR').AsString;
          mBS_Hacienda.FieldByName('IDENTIFICACION').AsString :=
            FieldByName('IDENTIFICACION').AsString;
          mBS_Hacienda.FieldByName('SITUACION').AsString :=
            FieldByName('SITUACION').AsString;
          mBS_Hacienda.FieldByName('SEGURIDAD').AsString :=
            FieldByName('SEGURIDAD').AsString;
          mBS_Hacienda.FieldByName('CLAVE').AsString :=
            FieldByName('CLAVE').AsString;
          mBS_Hacienda.FieldByName('MQR').AsString :=
            FieldByName('MQR').AsString;
          mBS_Hacienda.Post;
          Next;
        end;
      end;

      mWhere := TStringList.Create;
      mWhere.Add('A.Numero=' + IntToStr(_Numero));
      mDL_TB_FACTURASCLIENTESENCABEZADO := Clase_Tipo1.Create;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Consultar(_Resultado, _ErrorM, mWhere.Text);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      with mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset do
      begin
        First;
        while not Eof do
        begin
          mBS_facturasclientesencabezado.Append;
          mBS_facturasclientesencabezado.FieldByName('Factura_Numero').AsInteger :=
            FieldByName('NUMERO').AsInteger;
          mBS_facturasclientesencabezado.FieldByName('Fecha').AsString :=
            FormatDateTime('dd/MM/yyyy', FieldByName('Fecha').AsDateTime);
          mBS_facturasclientesencabezado.FieldByName('Hora').AsString :=
            FieldByName('HORA').AsString;
          mBS_facturasclientesencabezado.FieldByName('NombreCliente').AsString :=
            FieldByName('NOMBRECLIENTE').AsString;
          mBS_facturasclientesencabezado.FieldByName('SubTotal').AsFloat :=
            FieldByName('SUBTOTAL').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('DescuentoMonto').AsFloat :=
            FieldByName('DESCUENTOM').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('IVAMonto').AsFloat :=
            FieldByName('IVAM').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('Total').AsFloat :=
            FieldByName('TOTAL').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('FechaVencimiento').AsString :=
            FormatDateTime('dd/MM/yyyy', FieldByName('FECHAVENCIMIENTO').AsDateTime);
          mBS_facturasclientesencabezado.FieldByName('NombreVendedor').AsString :=
            FieldByName('NOMBREVENDEDOR').AsString;
          mBS_facturasclientesencabezado.FieldByName('Numero_Proforma').AsInteger :=
            FieldByName('NUMEROPROFORMA').AsInteger;
          mBS_facturasclientesencabezado.FieldByName('PagoCon').AsFloat :=
            FieldByName('PAGOCON').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('Cambio').AsFloat :=
            FieldByName('CAMBIO').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('DireccionCliente').AsString :=
            FieldByName('ClienteDireccion').AsString;
          mBS_facturasclientesencabezado.FieldByName('Telefono1Cliente').AsString :=
            FieldByName('ClienteTelefono1').AsString;
          mBS_facturasclientesencabezado.FieldByName('ServicioMonto').AsFloat :=
            FieldByName('ISM').AsFloat;
          mBS_facturasclientesencabezado.FieldByName('ContactoNombre').AsString :=
            FieldByName('ClienteContactoNombre').AsString;
          mBS_facturasclientesencabezado.Post;

          Next;
        end;
      end;
      mDL_TB_FACTURASCLIENTESENCABEZADO.Destroy;

      mWhere := TStringList.Create;
      mWhere.Add('A.Numero=' + IntToStr(_Numero));
      mDL_TB_FACTURASDETALLE := Clase_Tipo2.Create;
      mDL_TB_FACTURASDETALLE.Consultar(_Resultado, _ErrorM, mWhere.Text);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      with mDL_TB_FACTURASDETALLE.Dataset do
      begin
        First;
        while not Eof do
        begin
          mBS_facturasclientesdetalle.Append;
          mBS_facturasclientesdetalle.FieldByName('Codigo_Producto').AsString :=
            FieldByName('CODIGO').AsString;
          mBS_facturasclientesdetalle.FieldByName('Nombre_Producto').AsString :=
            FieldByName('NOMBRE').AsString;
          mBS_facturasclientesdetalle.FieldByName('Cantidad').AsFloat :=
            FieldByName('Cantidad').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitario').AsFloat :=
            FieldByName('PRECIOUNITARIO').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitarioFinal').AsFloat :=
            FieldByName('PRECIOUNITARIOFINAL').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('DescuentoMonto').AsFloat :=
            FieldByName('DESCUENTOM').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioFinal').AsFloat :=
            FieldByName('PRECIOFINAL').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('Impuesto').AsFloat :=
            FieldByName('IVAM').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitarioBase').AsFloat :=
            FieldByName('PRECIOUNITARIOBASE').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioFinalBase').AsFloat :=
            FieldByName('PRECIOFINALBASE').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('Descripcion1').AsString :=
            FieldByName('DESCRIPCION1').AsString;
          mBS_facturasclientesdetalle.FieldByName('Descripcion2').AsString :=
            FieldByName('DESCRIPCION2').AsString;
          mBS_facturasclientesdetalle.Post;

          Next;
        end;
      end;
      mDL_TB_FACTURASDETALLE.Destroy;

      mArchivo := TStringList.Create;

      mWhere := TStringList.Create;
      if _IdFormaPago = 1 then
        mWhere.Add('Id=' + IntToStr(1));
      if _IdFormaPago = 5 then
        mWhere.Add('Id=' + IntToStr(2));
      DL_TB_PLANTILLAS := TDL_TB_PLANTILLAS.Create;
      mArchivo.Text :=
        DL_TB_PLANTILLAS.Obtener_Plantilla(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      DL_TB_PLANTILLAS.Destroy;

      mNombreArchivo := Global.PathAplicacion + '\Plantilla.fr3';
      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      mArchivo.SaveToFile(mNombreArchivo);

      if mArchivo.Text = '' then
      begin
        _Resultado := 1;
        _ErrorM := 'No tiene plantilla';
                Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
        raise Exception.Create('');
      end;
      mArchivo.Free;

      dmReports.frxDBDataset1.DataSet := mBS_facturasclientesencabezado;
      dmReports.frxDBDataset2.DataSet := mBS_facturasclientesdetalle;
      dmReports.frxDBDataset3.DataSet := mDL_TB_EMPRESAS.Dataset;
      dmReports.frxDBDataset4.DataSet := mBS_Hacienda;


      dmReports.frxDBDataset1.Enabled := True;
      dmReports.frxDBDataset2.Enabled := True;
      dmReports.frxDBDataset3.Enabled := True;
      dmReports.frxDBDataset4.Enabled := True;

      try
        dmReports.frxReport1.LoadFromFile(mNombreArchivo);
      except
      end;

      dmReports.frxReport1.PrepareReport();
      dmReports.frxReport1.PrintOptions.Printer :=
        Global.ImpresoraRecibos;
  //    dmReports.frxReport1.ShowReport();
      dmReports.frxReport1.PrintOptions.ShowDialog := False;
      dmReports.frxReport1.Print;
      dmReports.frxDBDataset1.Enabled := False;
      dmReports.frxDBDataset2.Enabled := False;
      dmReports.frxDBDataset3.Enabled := False;
      dmReports.frxDBDataset4.Enabled := False;

      mDL_TB_EMPRESAS.Destroy;

      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure VistaPrevia;
var
  DL_TB_PLANTILLAS: TDL_TB_PLANTILLAS;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
  mArchivo: TStringList;
  mNombreArchivo: string;
  mDL_TB_EMPRESAS: TDL_TB_EMPRESAS;
  mBS_facturasclientesencabezado: TFDMemTable;
  mBS_facturasclientesdetalle: TFDMemTable;
  mNombrecliente, mNombreVendedor: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      mBS_facturasclientesencabezado := TFDMemTable.Create(nil);
      with mBS_facturasclientesencabezado do
      begin
        FieldDefs.Clear;
        FieldDefs.Add('Factura_Numero', ftInteger, 0);
        FieldDefs.Add('Fecha', ftDateTime, 0);
        FieldDefs.Add('Hora', ftString, 30);
        FieldDefs.Add('CodigoCliente', ftString, 300);
        FieldDefs.Add('NombreCliente', ftString, 300);
        FieldDefs.Add('SubTotal', ftFloat, 0);
        FieldDefs.Add('DescuentoPorcentaje', ftFloat, 0);
        FieldDefs.Add('DescuentoMonto', ftFloat, 0);
        FieldDefs.Add('IVAPorcentaje', ftFloat, 0);
        FieldDefs.Add('IVAMonto', ftFloat, 0);
        FieldDefs.Add('Transporte', ftFloat, 0);
        FieldDefs.Add('Total', ftFloat, 0);
        FieldDefs.Add('TotalGravado', ftFloat, 0);
        FieldDefs.Add('TotalExcento', ftFloat, 0);
        FieldDefs.Add('Estado', ftString, 300);
        FieldDefs.Add('FormaPago', ftString, 300);
        FieldDefs.Add('Moneda', ftString, 300);
        FieldDefs.Add('TipoCambio', ftFloat, 0);
        FieldDefs.Add('Serie', ftString, 300);
        FieldDefs.Add('Impresa', ftString, 300);
        FieldDefs.Add('NumeroDoc', ftString, 300);
        FieldDefs.Add('FechaVencimiento', ftDateTime, 0);
        FieldDefs.Add('Tipo', ftInteger, 0);
        FieldDefs.Add('Saldo', ftFloat, 0);
        FieldDefs.Add('CarCredito', ftString, 300);
        FieldDefs.Add('CarContado', ftString, 300);
        FieldDefs.Add('CodigoVendedor', ftString, 300);
        FieldDefs.Add('NombreVendedor', ftString, 300);
        FieldDefs.Add('Numero_Proforma', ftInteger, 0);
        FieldDefs.Add('PagoCon', ftFloat, 0);
        FieldDefs.Add('Cambio', ftFloat, 0);
        FieldDefs.Add('FraseMayorista', ftString, 300);
        FieldDefs.Add('DireccionCliente', ftString, 300);
        FieldDefs.Add('Telefono1Cliente', ftString, 300);
        FieldDefs.Add('ServicioMonto', ftFloat, 0);
        FieldDefs.Add('ContactoNombre', ftString, 300);
        CreateDataSet;
        Open;
      end;

      mBS_facturasclientesdetalle := TFDMemTable.Create(nil);
      with mBS_facturasclientesdetalle do
      begin
        FieldDefs.Clear;
        FieldDefs.Add('Codigo_Producto', ftString, 300);
        FieldDefs.Add('Nombre_Producto', ftString, 300);
        FieldDefs.Add('Cantidad', ftFloat, 0);
        FieldDefs.Add('UnidadMedida', ftString, 300);
        FieldDefs.Add('PrecioUnitario', ftFloat, 0);
        FieldDefs.Add('PrecioUnitarioFinal', ftFloat, 0);
        FieldDefs.Add('DescuentoPorcentaje', ftFloat, 0);
        FieldDefs.Add('DescuentoMonto', ftFloat, 0);
        FieldDefs.Add('PrecioFinal', ftFloat, 0);
        FieldDefs.Add('Impuesto', ftFloat, 0);
        FieldDefs.Add('PrecioMayoristaAplicado', ftString, 300);
        FieldDefs.Add('Descripcion_Producto', ftString, 300);
        FieldDefs.Add('CodigoBarras', ftString, 300);
        FieldDefs.Add('PrecioUnitarioBase', ftFloat, 0);
        FieldDefs.Add('PrecioFinalBase', ftFloat, 0);
        FieldDefs.Add('Descripcion1', ftString, 300);
        FieldDefs.Add('Descripcion2', ftString, 300);
        CreateDataSet;
        Open;
      end;

      mDL_TB_EMPRESAS := TDL_TB_EMPRESAS.Create;
      mDL_TB_EMPRESAS.Consultar(_Resultado, _ErrorM);
      if _Resultado = -1 then
        raise Exception.Create('');

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mBS_facturasclientesencabezado.Append;
      mBS_facturasclientesencabezado.FieldByName('Factura_Numero').AsInteger :=
        _Numero;
      mBS_facturasclientesencabezado.FieldByName('Fecha').AsString :=
        FormatDateTime('dd/MM/yyyy', dtpFecha.Date);
      mBS_facturasclientesencabezado.FieldByName('Hora').AsString :=
        FormatDateTime('HH:mm:ss', Time);
      if Trim(cbCliente.Text) <> '[SIN SELECCIONAR]' then
        mNombrecliente := Trim(cbCliente.Text)
      else
        mNombrecliente := '';
      mBS_facturasclientesencabezado.FieldByName('NombreCliente').AsString :=
        mNombrecliente;
      mBS_facturasclientesencabezado.FieldByName('SubTotal').AsFloat :=
        _SubTotal;
      mBS_facturasclientesencabezado.FieldByName('DescuentoMonto').AsFloat :=
        _DescuentoM;
      mBS_facturasclientesencabezado.FieldByName('IVAMonto').AsFloat :=
        _IVAM;
      mBS_facturasclientesencabezado.FieldByName('Total').AsFloat :=
        _Total;
     // mBS_facturasclientesencabezado.FieldByName('FechaVencimiento').AsString :=
     //   FormatDateTime('dd/MM/yyyy', FieldByName('FECHAVENCIMIENTO').AsDateTime);
      if Trim(cbVendedor.Text) <> '[SIN SELECCIONAR]' then
        mNombreVendedor := Trim(cbVendedor.Text)
      else
        mNombreVendedor := '';
      mBS_facturasclientesencabezado.FieldByName('NombreVendedor').AsString :=
        mNombreVendedor;
      mBS_facturasclientesencabezado.FieldByName('ServicioMonto').AsFloat :=
        _ISM;
      mBS_facturasclientesencabezado.Post;

      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        First;
        while not Eof do
        begin
          mBS_facturasclientesdetalle.Append;
          mBS_facturasclientesdetalle.FieldByName('Codigo_Producto').AsString :=
            FieldByName('CODIGO').AsString;
          mBS_facturasclientesdetalle.FieldByName('Nombre_Producto').AsString :=
            FieldByName('NOMBRE').AsString;
          mBS_facturasclientesdetalle.FieldByName('Cantidad').AsFloat :=
            FieldByName('Cantidad').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitario').AsFloat :=
            FieldByName('PRECIOUNITARIO').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitarioFinal').AsFloat :=
            FieldByName('PRECIOUNITARIOFINAL').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('DescuentoMonto').AsFloat :=
            FieldByName('DESCUENTOM').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioFinal').AsFloat :=
            FieldByName('PRECIOFINAL').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('Impuesto').AsFloat :=
            FieldByName('IVAM').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioUnitarioBase').AsFloat :=
            FieldByName('PRECIOUNITARIOBASE').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('PrecioFinalBase').AsFloat :=
            FieldByName('PRECIOFINALBASE').AsFloat;
          mBS_facturasclientesdetalle.FieldByName('Descripcion1').AsString :=
            FieldByName('DESCRIPCION1').AsString;
          mBS_facturasclientesdetalle.FieldByName('Descripcion2').AsString :=
            FieldByName('DESCRIPCION2').AsString;
          mBS_facturasclientesdetalle.Post;

          Next;
        end;
      end;

      mArchivo := TStringList.Create;

      mWhere := TStringList.Create;
      if _IdFormaPago = 1 then
        mWhere.Add('Id=' + IntToStr(1));
      if _IdFormaPago = 5 then
        mWhere.Add('Id=' + IntToStr(2));
      DL_TB_PLANTILLAS := TDL_TB_PLANTILLAS.Create;
      mArchivo.Text :=
        DL_TB_PLANTILLAS.Obtener_Plantilla(mWhere.Text, _Resultado, _ErrorM);
      mWhere.Free;
      if _Resultado = -1 then
        raise Exception.Create('');
      DL_TB_PLANTILLAS.Destroy;

      mNombreArchivo := Global.PathAplicacion + '\Plantilla.fr3';
      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      mArchivo.SaveToFile(mNombreArchivo);
      mArchivo.Free;

      dmReports.frxDBDataset1.DataSet := mBS_facturasclientesencabezado;
      dmReports.frxDBDataset2.DataSet := mBS_facturasclientesdetalle;
      dmReports.frxDBDataset3.DataSet := mDL_TB_EMPRESAS.Dataset;
      dmReports.frxDBDataset1.Enabled := True;
      dmReports.frxDBDataset2.Enabled := True;
      dmReports.frxDBDataset3.Enabled := True;

      dmReports.frxReport1.LoadFromFile(mNombreArchivo);
      dmReports.frxReport1.PrepareReport();
      dmReports.frxReport1.ShowReport();
//      dmReports.frxReport1.PrintOptions.ShowDialog := False;
 //     dmReports.frxReport1.Print;
      dmReports.frxDBDataset1.Enabled := False;
      dmReports.frxDBDataset2.Enabled := False;
      dmReports.frxDBDataset3.Enabled := False;

      mDL_TB_EMPRESAS.Destroy;

      if FileExists(mNombreArchivo) = True then
        DeleteFile(mNombreArchivo);

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      if _Resultado = -1 then
      begin
        Application.MessageBox(PChar('Ha ocurrido un error' + #13+#10 + _ErrorM),
          'Error', MB_ICONERROR);
      end;
      if _Resultado = 0 then
      begin
        Application.MessageBox(PChar(_ErrorM),
          'Advertencia', MB_ICONWARNING);
      end;
      _Resultado := -1;
    end;

  end;
end;

procedure Cerrar;
begin
  with Forma01 do
  begin

    Close;

  end;
end;

procedure Consultar_Encabezado(pId: Integer);
var
  mDL_TB_FACTURASCLIENTESENCABEZADO: Clase_Tipo1;
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mDL_TB_FACTURASCLIENTESENCABEZADO := Clase_Tipo1.Create;
      mWhere := TStringList.Create;
      mWhere.Add('A.Id=' + IntToStr(pId));
      mDL_TB_FACTURASCLIENTESENCABEZADO.Consultar(_Resultado, _ErrorM, mWhere.Text, '');
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;
      DBToFormaEncabezado(mDL_TB_FACTURASCLIENTESENCABEZADO.Dataset);
      mDL_TB_FACTURASCLIENTESENCABEZADO.Destroy;

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      _Resultado := -1;
    end;

  end;
end;

procedure DBToFormaEncabezado(ds1: TDatasetMem);
begin
  with Forma01 do
  begin

    with ds1 do
    begin
      dtpFecha.Date :=
        FieldByName('FECHA').AsDateTime;
      pnlTotal.Caption :=
        FormatFloat('#,##0.00',
        FieldByName('TOTAL').AsFloat);
      cbCliente.ItemIndex := SetCombo(cbCliente,
        FieldByName('IdCliente').AsInteger);
      cbVendedor.ItemIndex := SetCombo(cbVendedor,
        FieldByName('IdVendedor').AsInteger);
      pnlSubTotal.Caption :=
        FormatFloat('#,##0.00',
        FieldByName('SUBTOTAL').AsFloat);
      pnlDescuento.Caption :=
        FormatFloat('#,##0.00',
        FieldByName('DESCUENTOM').AsFloat);
      pnlServicio.Caption :=
        FormatFloat('#,##0.00',
        FieldByName('ISM').AsFloat);
      pnlImpuesto.Caption :=
        FormatFloat('#,##0.00',
        FieldByName('IVAM').AsFloat);
    end;

  end;
end;

procedure Consultar_Detalle(pId: Integer);
var
  mWhere: TStringList;
  mResultado: Integer;
  mErrorM: string;
begin
  with Forma01 do
  begin

    try
      _Resultado := 1;

      _MainConexion.Iniciar_Transaccion(_Resultado, _ErrorM);

      mWhere := TStringList.Create;
      mWhere.Add('A.Numero=' + IntToStr(pId));
      _DL_TB_FACTURASDETALLEActual.Consultar(_Resultado, _ErrorM, mWhere.Text, '');
      if _Resultado = -1 then
        raise Exception.Create('');
      mWhere.Free;
      LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
      ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);

      _MainConexion.Aceptar_Transaccion(_Resultado, _ErrorM);

      _Resultado := 1;
    except
      mResultado := _Resultado;
      mErrorM := _ErrorM;
      _MainConexion.Rechazar_Transaccion(_Resultado, _ErrorM);
      _Resultado := mResultado;
      _ErrorM := mErrorM;
      _Resultado := -1;
    end;

  end;
end;

procedure CamposValidos_Pagar1;
var
  mValido: Boolean;
begin
  with Forma01 do
  begin

    _Resultado := 1;
    mValido := True;

    if (mValido = True) and (_DL_TB_FACTURASDETALLEActual.Dataset.RecordCount = 0) then
    begin
      mValido := False;
      _ErrorM := 'Debe tener detalles';
    end;

    if mValido = False then
      _Resultado := 0;

  end;
end;

procedure CamposValidos_Pagar2;
var
  mValido: Boolean;
  mDL_TB_CLIENTES: TDL_TB_CLIENTES;
  mWhere: TStringList;
  mAPLICARLIMITECREDITO: Integer;
begin
  with Forma01 do
  begin

    _Resultado := 1;
    mValido := True;

    if (mValido = True) and (_IdFormaPago = 5) then
    begin
      if (GetCombo(cbCliente) <= 0)  then
      begin
        mValido := False;
        _ErrorM := 'Debe Seleccionar un cliente';
      end;
    end;
    if (mValido = True) and (_IdFormaPago = 5) then
    begin
      mWhere := TStringList.Create;
      mWhere.Add('Id=' + IntToStr(GetCombo(cbCliente)));
      mDL_TB_CLIENTES := TDL_TB_CLIENTES.Create;
      mAPLICARLIMITECREDITO :=
        mDL_TB_CLIENTES.Obtener_Valor(mWhere.Text,
          'APLICARLIMITECREDITO', _Resultado, _ErrorM);
      mWhere.Free;
      mDL_TB_CLIENTES.Destroy;
      if mAPLICARLIMITECREDITO = 1 then
      begin
        if (edtLimiteCredito.Value  < _Total)  then
        begin
          mValido := False;
          _ErrorM := 'Limíte de Crédito Superado';
        end;
      end;
    end;

    if mValido = False then
      _Resultado := 0;

  end;
end;

procedure CamposValidos_Detalle;
var
  mValido: Boolean;
begin
  with Forma01 do
  begin

    _Resultado := 1;
    mValido := True;

    if mValido = False then
      _Resultado := 0;

  end;
end;

procedure ProductoFueraInventario;
begin
  with Forma01 do
  begin

    FormProductoFueraInventario01.ShowModal;
    if FormProductoFueraInventario01.Tag = 1 then
    begin
      // Llena el DataSet
      with _DL_TB_FACTURASDETALLEActual.Dataset do
      begin
        Append;
        FieldByName('CODIGO').Tag := 1;
        FieldByName('CODIGO').AsString := '0';
        FieldByName('NOMBRE').Tag := 1;
        FieldByName('NOMBRE').AsString :=
          FormProductoFueraInventario01._Nombre;
        FieldByName('CANTIDAD').Tag := 1;
        FieldByName('CANTIDAD').AsFloat :=
          FormProductoFueraInventario01._Cantidad;
        FieldByName('PRECIOUNITARIO').Tag := 1;
        FieldByName('PRECIOUNITARIO').AsFloat :=
          FormProductoFueraInventario01._Precio;
        FieldByName('DESCUENTOP').Tag := 1;
        FieldByName('DESCUENTOP').AsFloat := 0;
        FieldByName('DESCUENTOM').Tag := 1;
        FieldByName('DESCUENTOM').AsFloat := 0;
        FieldByName('IVAP').Tag := 1;
        FieldByName('IVAP').AsFloat := 0;
        FieldByName('IVAM').Tag := 1;
        FieldByName('IVAM').AsFloat := 0;
        FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
        FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
          FormProductoFueraInventario01._Precio;
        FieldByName('PRECIOFINAL').Tag := 1;
        FieldByName('PRECIOFINAL').AsFloat :=
          FormProductoFueraInventario01._Total;
        FieldByName('LINEA').Tag := 1;
        FieldByName('LINEA').AsInteger := 0;
        FieldByName('PRECIOMAYORISTAAPLICADO').Tag := 1;
        FieldByName('PRECIOMAYORISTAAPLICADO').AsInteger := 0;
        FieldByName('ISP').Tag := 1;
        FieldByName('ISP').AsFloat := 0;
        FieldByName('ISM').Tag := 1;
        FieldByName('ISM').AsFloat := 0;
        FieldByName('PRECIOUNITARIOBASE').Tag := 1;
        FieldByName('PRECIOUNITARIOBASE').AsFloat := 0;
        FieldByName('PRECIOFINALBASE').Tag := 1;
        FieldByName('PRECIOFINALBASE').AsFloat := 0;
        FieldByName('IdProducto').Tag := 1;
        FieldByName('IdProducto').AsInteger := 0;
        Post;
      end;

      LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
      ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
    end;

    if Global.CodigoBarrasDirecto = 0 then
      edtCodigoProducto.SetFocus;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure UsarPrecioMayorista;
var
  mEncontrado: Boolean;
  mLinea: string;
  mId: Integer;
  mPrecioMayorista: Double;
  mDL_TB_PRODUCTOS: TDL_TB_PRODUCTOS;
  mWhere: TStringList;
begin
  with Forma01 do
  begin

    if lvLista1.Selected <> nil then
    begin
      mLinea := lvLista1.Selected.SubItems[5];
      try
        mId := StrToInt(mLinea);
      except
        mId := 0;
      end;

      if mId > 0 then
      begin
        mEncontrado :=
          _DL_TB_FACTURASDETALLEActual.Dataset.Locate('IdProducto',
            mId, []);
        if mEncontrado = True then
        begin
          mWhere := TStringList.Create;
          mWhere.Add('Id=' + IntToStr(mId));
          mDL_TB_PRODUCTOS := TDL_TB_PRODUCTOS.Create;
          mPrecioMayorista :=
            mDL_TB_PRODUCTOS.Obtener_PrecioMayorista(mWhere.Text, _Resultado, _ErrorM);
          mWhere.Free;
          mDL_TB_PRODUCTOS.Destroy;
          if mPrecioMayorista > 0 then
          begin
            // Llena el DataSet
            with _DL_TB_FACTURASDETALLEActual.Dataset do
            begin
              Edit;
              FieldByName('PRECIOUNITARIO').Tag := 1;
              FieldByName('PRECIOUNITARIO').AsFloat :=
                mPrecioMayorista;
              FieldByName('DESCUENTOP').Tag := 1;
              FieldByName('DESCUENTOP').AsFloat := 0;
              FieldByName('DESCUENTOM').Tag := 1;
              FieldByName('DESCUENTOM').AsFloat := 0;
              FieldByName('IVAP').Tag := 1;
              FieldByName('IVAP').AsFloat := 0;
              FieldByName('IVAM').Tag := 1;
              FieldByName('IVAM').AsFloat := 0;
              FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
              FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
                mPrecioMayorista;
              FieldByName('PRECIOFINAL').Tag := 1;
              FieldByName('PRECIOFINAL').AsFloat :=
                mPrecioMayorista * FieldByName('Cantidad').AsFloat;
              FieldByName('LINEA').Tag := 1;
              FieldByName('LINEA').AsInteger := 0;
              FieldByName('PRECIOMAYORISTAAPLICADO').Tag := 1;
              FieldByName('PRECIOMAYORISTAAPLICADO').AsInteger := 1;
              FieldByName('ISP').Tag := 1;
              FieldByName('ISP').AsFloat := 0;
              FieldByName('ISM').Tag := 1;
              FieldByName('ISM').AsFloat := 0;
              FieldByName('PRECIOUNITARIOBASE').Tag := 1;
              FieldByName('PRECIOUNITARIOBASE').AsFloat := 0;
              FieldByName('PRECIOFINALBASE').Tag := 1;
              FieldByName('PRECIOFINALBASE').AsFloat := 0;
              FieldByName('IdProducto').Tag := 1;
              FieldByName('IdProducto').AsInteger := 0;
              Post;
            end;

            LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
            ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
          end;
        end;
      end;
    end;

    if Global.CodigoBarrasDirecto = 0 then
      edtCodigoProducto.SetFocus;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure CambiarDetalle;
var
  mLinea: string;
  mId: Integer;
  mEncontrado: Boolean;
  mDescuento: Double;
  mCantidad, mPrecio, mPrecioServicio: Double;
  mDescuentoPM, mDescuentoP, mDescuentoM, mPrecioDescuento: Double;
  mIVAPM, mIVAPorcentaje, mIVAM, mPrecioFinal, mMonto: Double;
  mDescripcion1: string;
  mDescripcion2: string;
begin
  with Forma01 do
  begin

    mCantidad := 0;
    if lvLista1.Selected <> nil then
    begin
      mLinea := lvLista1.Selected.SubItems[5];
      try
        mId := StrToInt(mLinea);
      except
        mId := 0;
      end;
      mEncontrado :=
        _DL_TB_FACTURASDETALLEActual.Dataset.Locate('IdProducto', mId, []);
      if mEncontrado = True then
      begin
        mCantidad := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('CANTIDAD').AsFloat;
        mPrecio :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('PRECIOUNITARIO').AsFloat;
        mDescuento :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCUENTOP').AsFloat;
        mIVAPorcentaje :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('IVAP').AsFloat;
        mDescripcion1 := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCRIPCION1').AsString;
        mDescripcion2 := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCRIPCION2').AsString;
      end;
      if mEncontrado = True then
      begin
        FormCambiarDetalle01._Origen := 1;
        FormCambiarDetalle01._DescuentoPd := mDescuento;
        FormCambiarDetalle01._Cantidad := mCantidad;
        FormCambiarDetalle01._Precio := mPrecio;
        FormCambiarDetalle01._Descripcion1 := mDescripcion1;
        FormCambiarDetalle01._Descripcion2 := mDescripcion2;
        FormCambiarDetalle01.ShowModal;
        if FormCambiarDetalle01.Tag = 1 then
        begin
          mCantidad := FormCambiarDetalle01._Cantidad;
          mDescuento := FormCambiarDetalle01._DescuentoPd;
          mDescripcion1 := FormCambiarDetalle01._Descripcion1;
          mDescripcion2 := FormCambiarDetalle01._Descripcion2;

          // Calcula el Descuento
          mDescuentoPM := 0;
          mDescuentoP := mDescuento;
          if mDescuentoP <> 0 then
            mDescuentoPM := mDescuentoP / 100;
          mDescuentoM := (mPrecio * mDescuentoPM) * mCantidad;
          mPrecioDescuento := mPrecio - (mPrecio * mDescuentoPM);

          mPrecioServicio := mPrecioDescuento;

          // Calcula el Impuesto
          mIVAPM := 0;
          if mIVAPorcentaje <> 0 then
            mIVAPM := mIVAPorcentaje / 100;
          mIVAM := (mPrecioServicio * mIVAPM) * mCantidad;
          mPrecioFinal := mPrecioServicio;

          mMonto := mPrecioFinal * mCantidad;

          // Llena el DataSet
          with _DL_TB_FACTURASDETALLEActual.Dataset do
          begin
            Edit;
            FieldByName('CANTIDAD').Tag := 1;
            FieldByName('CANTIDAD').AsFloat :=
              FormCambiarDetalle01._Cantidad;
            FieldByName('DESCUENTOP').Tag := 1;
            FieldByName('DESCUENTOP').AsFloat :=
              mDescuentoP;
            FieldByName('DESCUENTOM').Tag := 1;
            FieldByName('DESCUENTOM').AsFloat :=
              mDescuentoM;
            FieldByName('IVAM').Tag := 1;
            FieldByName('IVAM').AsFloat :=
              mIVAM;
            FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
            FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
              mPrecioFinal;
            FieldByName('PRECIOFINAL').Tag := 1;
            FieldByName('PRECIOFINAL').AsFloat :=
              mMonto;
            FieldByName('DESCRIPCION1').Tag := 1;
            FieldByName('DESCRIPCION1').AsString :=
              mDescripcion1;
            FieldByName('DESCRIPCION2').Tag := 1;
            FieldByName('DESCRIPCION2').AsString :=
              mDescripcion2;
            Post;
          end;

          LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
          ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
        end;
      end;
    end;

    if Global.CodigoBarrasDirecto = 0 then
      edtCodigoProducto.SetFocus;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure CambiarDetalleCantidad(pOperacion: Integer);
var
  mLinea: string;
  mId: Integer;
  mEncontrado: Boolean;
  mDescuento: Double;
  mCantidad, mPrecio, mPrecioServicio: Double;
  mDescuentoPM, mDescuentoP, mDescuentoM, mPrecioDescuento: Double;
  mIVAPM, mIVAPorcentaje, mIVAM, mPrecioFinal, mMonto: Double;
  mDescripcion1: string;
  mDescripcion2: string;
begin
  with Forma01 do
  begin

    mCantidad := 0;
    if lvLista1.Selected <> nil then
    begin
      mLinea := lvLista1.Selected.SubItems[5];
      try
        mId := StrToInt(mLinea);
      except
        mId := 0;
      end;
      mEncontrado :=
        _DL_TB_FACTURASDETALLEActual.Dataset.Locate('IdProducto', mId, []);
      if mEncontrado = True then
      begin
        mCantidad := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('CANTIDAD').AsFloat;
        mPrecio :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('PRECIOUNITARIO').AsFloat;
        mDescuento :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCUENTOP').AsFloat;
        mIVAPorcentaje :=  _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('IVAP').AsFloat;
        mDescripcion1 := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCRIPCION1').AsString;
        mDescripcion2 := _DL_TB_FACTURASDETALLEActual.Dataset.FieldByName('DESCRIPCION2').AsString;
      end;
      if mEncontrado = True then
      begin
        if pOperacion = 1 then
          mCantidad := mCantidad + 1;
        if pOperacion = 2 then
        begin
          if mCantidad > 1 then
            mCantidad := mCantidad - 1;
        end;
        // Calcula el Descuento
        mDescuentoPM := 0;
        mDescuentoP := mDescuento;
        if mDescuentoP <> 0 then
          mDescuentoPM := mDescuentoP / 100;
        mDescuentoM := (mPrecio * mDescuentoPM) * mCantidad;
        mPrecioDescuento := mPrecio - (mPrecio * mDescuentoPM);

        mPrecioServicio := mPrecioDescuento;

        // Calcula el Impuesto
        mIVAPM := 0;
        if mIVAPorcentaje <> 0 then
          mIVAPM := mIVAPorcentaje / 100;
        mIVAM := (mPrecioServicio * mIVAPM) * mCantidad;
        mPrecioFinal := mPrecioServicio;

        mMonto := mPrecioFinal * mCantidad;

        // Llena el DataSet
        with _DL_TB_FACTURASDETALLEActual.Dataset do
        begin
          Edit;
          FieldByName('CANTIDAD').Tag := 1;
          FieldByName('CANTIDAD').AsFloat :=
            mCantidad;
          FieldByName('DESCUENTOP').Tag := 1;
          FieldByName('DESCUENTOP').AsFloat :=
            mDescuentoP;
          FieldByName('DESCUENTOM').Tag := 1;
          FieldByName('DESCUENTOM').AsFloat :=
            mDescuentoM;
          FieldByName('IVAM').Tag := 1;
          FieldByName('IVAM').AsFloat :=
            mIVAM;
          FieldByName('PRECIOUNITARIOFINAL').Tag := 1;
          FieldByName('PRECIOUNITARIOFINAL').AsFloat :=
            mPrecioFinal;
          FieldByName('PRECIOFINAL').Tag := 1;
          FieldByName('PRECIOFINAL').AsFloat :=
            mMonto;
          FieldByName('DESCRIPCION1').Tag := 1;
          FieldByName('DESCRIPCION1').AsString :=
            mDescripcion1;
          FieldByName('DESCRIPCION2').Tag := 1;
          FieldByName('DESCRIPCION2').AsString :=
            mDescripcion2;
          Post;
        end;

        LlenarlvLista1(lvLista1, _DL_TB_FACTURASDETALLEActual.Dataset);
        ActualizarTotales(_DL_TB_FACTURASDETALLEActual.Dataset);
      end;
    end;

  end;
end;

procedure DescuentoMonto;
var
  mDescuento, mPrecio: Double;
begin
  with Forma01 do
  begin

    FormDesuentoMonto01.ShowModal;
    if FormDesuentoMonto01.Tag = 1 then
    begin
      mPrecio := edtPrecio.Value * edtCantidad.Value;
      // Calcula el Descuento
      if (FormDesuentoMonto01._Monto <> 0) and
        (mPrecio <> 0) then
      begin
        mDescuento := FormDesuentoMonto01._Monto / mPrecio;
        mDescuento := mDescuento * 100;
        edtDescuento.Value := mDescuento;
      end;
    end;

  end;
end;

procedure Insertar_AsientoDetalle(pAsientoDetalle: TDL_TB_AsientosDetalle;
  pIdAsiento: Integer; pTipoPago: Integer);
var
  mCantidad, mPrecioUnitario, mValor: Double;
begin
  with Forma01 do
  begin

    with _DL_TB_FACTURASDETALLEActual.Dataset do
    begin
      First;
      while not Eof do
      begin
        mCantidad :=
          FieldByName('CANTIDAD').AsFloat;
        mPrecioUnitario :=
          FieldByName('PRECIOUNITARIO').AsFloat;
        mValor := mPrecioUnitario * mCantidad;

        pAsientoDetalle.Dataset.Append;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').AsInteger :=
          pIdAsiento;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').AsInteger := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').Tag := 1;
        if pTipoPago = 1 then
          pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 15;
        if pTipoPago = 5 then
          pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 18;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').AsString := 'Venta de mercaderías';
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').AsString := '';
        pAsientoDetalle.Dataset.FieldByName('MONTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('MONTO').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('DEBE').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DEBE').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('HABER').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('HABER').AsFloat := 0;
        pAsientoDetalle.Dataset.Post;

        pAsientoDetalle.Dataset.Append;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').AsInteger :=
          pIdAsiento;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').AsInteger := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 20;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').AsString := 'Venta de mercaderías';
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').AsString := '';
        pAsientoDetalle.Dataset.FieldByName('MONTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('MONTO').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('DEBE').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DEBE').AsFloat := 0;
        pAsientoDetalle.Dataset.FieldByName('HABER').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('HABER').AsFloat := mValor;
        pAsientoDetalle.Dataset.Post;
        Next;
      end;
    end;

  end;
end;

procedure Insertar_AsientoDetalle_Anulado(pAsientoDetalle: TDL_TB_AsientosDetalle;
  pIdAsiento: Integer; pTipoPago: Integer);
var
  mCantidad, mPrecioUnitario, mValor: Double;
begin
  with Forma01 do
  begin

    with _DL_TB_FACTURASDETALLEActual.Dataset do
    begin
      First;
      while not Eof do
      begin
        mCantidad :=
          FieldByName('CANTIDAD').AsFloat;
        mPrecioUnitario :=
          FieldByName('PRECIOUNITARIO').AsFloat;
        mValor := mPrecioUnitario * mCantidad;

        pAsientoDetalle.Dataset.Append;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').AsInteger :=
          pIdAsiento;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').AsInteger := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').Tag := 1;
        if pTipoPago = 1 then
          pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 15;
        if pTipoPago = 5 then
          pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 18;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').AsString := 'Venta de mercaderías';
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').AsString := '';
        pAsientoDetalle.Dataset.FieldByName('MONTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('MONTO').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('DEBE').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DEBE').AsFloat := 0;
        pAsientoDetalle.Dataset.FieldByName('HABER').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('HABER').AsFloat := mValor;
        pAsientoDetalle.Dataset.Post;

        pAsientoDetalle.Dataset.Append;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDENCABEZADO').AsInteger :=
          pIdAsiento;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDMOVIMIENTO').AsInteger := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('IDCUENTA').AsInteger := 20;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DESCRIPCION').AsString := 'Venta de mercaderías';
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('REFERENCIA').AsString := '';
        pAsientoDetalle.Dataset.FieldByName('MONTO').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('MONTO').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('DEBE').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('DEBE').AsFloat := mValor;
        pAsientoDetalle.Dataset.FieldByName('HABER').Tag := 1;
        pAsientoDetalle.Dataset.FieldByName('HABER').AsFloat := 0;
        pAsientoDetalle.Dataset.Post;
        Next;
      end;
    end;

  end;
end;

procedure Actualizar_Detalles(ds1: TDatasetMem);
begin
  with Forma01 do
  begin


  end;
end;

procedure Sumar;
var
  mId: Integer;
begin
  with Forma01 do
  begin

    if lvLista1.Selected <> nil then
    begin
      mId := lvLista1.Selected.Index;
      CambiarDetalleCantidad(1);
      lvLista1.ItemIndex := mId;
      lvLista1.SetFocus;
    end;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure Restar;
var
  mId: Integer;
begin
  with Forma01 do
  begin

    if lvLista1.Selected <> nil then
    begin
      mId := lvLista1.Selected.Index;
      CambiarDetalleCantidad(2);
      lvLista1.ItemIndex := mId;
      lvLista1.SetFocus;
    end;
    if Global.CodigoBarrasDirecto = 1 then
      edtCodigoBarras.SetFocus;

  end;
end;

procedure CargarIdioma;
var
  mValor: string;
  mCount, mLen, mCount2: Integer;
begin
  with Forma01 do
  begin

    for mCount := 0 to Forma01.ComponentCount - 1 do
    begin
      if Forma01.Components[mCount] is TLabel then
      begin
        mValor := TLabel(Forma01.Components[mCount]).Caption;
        mLen := Length(mValor);
        if mValor[mLen] = ':' then
          mValor := Copy(mValor, 1, mLen - 1);
        mValor := dmLenguajes.GetValue(mValor);
        if Trim(mValor) <> '' then
          TLabel(Forma01.Components[mCount]).Caption := mValor;
      end;
      if Forma01.Components[mCount] is TBitBtn then
      begin
        mValor := TBitBtn(Forma01.Components[mCount]).Caption;
        mValor := dmLenguajes.GetValue(mValor);
        if Trim(mValor) <> '' then
          TBitBtn(Forma01.Components[mCount]).Caption := mValor;
      end;
      if Forma01.Components[mCount] is TRzPanel then
      begin
        mValor := TRzPanel(Forma01.Components[mCount]).Caption;
        mValor := dmLenguajes.GetValue(mValor);
        if Trim(mValor) <> '' then
          TRzPanel(Forma01.Components[mCount]).Caption := mValor;
      end;
      if Forma01.Components[mCount] is TRzListView then
      begin
        for mCount2 := 0 to TRzListView(Forma01.Components[mCount]).Columns.Count - 1 do
        begin
          mValor := TRzListView(Forma01.Components[mCount]).Columns[mCount2].Caption;
          mValor := dmLenguajes.GetValue(mValor);
          if Trim(mValor) <> '' then
            TRzListView(Forma01.Components[mCount]).Columns[mCount2].Caption := mValor;
        end;
      end;
    end;

  end;
end;
{$ENDREGION}

end.
